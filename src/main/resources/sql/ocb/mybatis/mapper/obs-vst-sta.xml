<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.ocb.ObsVstStaRepository">
    <select id="getVisitorListForGridPerDay" parameterType="JqGridRequest" resultType="ObsVstSta">
        select   TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                 uv AS uv,
                 lv AS lv,
                 pv AS pv,
                 rv AS rv,
                 vst_cnt AS vst_cnt,
                 round(time_spt_f_vst)/1000 AS time_spt_f_vst,
                 bunc_rate AS bunc_rate
            from obs_d_vst_sta
            where std_dt between #{startDate} and #{endDate}
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}
        </if>
        <if test="sidx == 'uv'">
            ORDER BY uv ${sord}
        </if>
        <if test="sidx == 'lv'">
            ORDER BY lv ${sord}
        </if>
        <if test="sidx == 'pv'">
            ORDER BY pv ${sord}
        </if>
        <if test="sidx == 'rv'">
            ORDER BY rv ${sord}
        </if>
        <if test="sidx == 'vstCnt'">
            ORDER BY vst_cnt ${sord}
        </if>
        <if test="sidx == 'timeSptFVst'">
            ORDER BY time_spt_f_vst ${sord}
        </if>
        <if test="sidx == 'buncRate'">
            ORDER BY bunc_rate ${sord}
        </if>
    </select>
    <select id="getVisitorListForGridPerWeek" parameterType="JqGridRequest" resultType="ObsVstSta">
        select   TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                 uv AS uv,
                 lv AS lv,
                 pv AS pv,
                 rv AS rv,
                 vst_cnt AS vst_cnt,
                 round(time_spt_f_vst)/1000 AS time_spt_f_vst,
                 bunc_rate AS bunc_rate
            from obs_w_vst_sta
            where std_dt <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}
        </if>
        <if test="sidx == 'uv'">
            ORDER BY uv ${sord}
        </if>
        <if test="sidx == 'lv'">
            ORDER BY lv ${sord}
        </if>
        <if test="sidx == 'pv'">
            ORDER BY pv ${sord}
        </if>
        <if test="sidx == 'rv'">
            ORDER BY rv ${sord}
        </if>
        <if test="sidx == 'vstCnt'">
            ORDER BY vst_cnt ${sord}
        </if>
        <if test="sidx == 'timeSptFVst'">
            ORDER BY time_spt_f_vst ${sord}
        </if>
        <if test="sidx == 'buncRate'">
            ORDER BY bunc_rate ${sord}
        </if>
    </select>
    <select id="getVisitorListForGridPerMonth" parameterType="JqGridRequest" resultType="ObsVstSta">
        select   TO_CHAR(TO_DATE(std_ym,'YYYYMM'),'YYYY-MM') as std_dt,
                 uv AS uv,
                 lv AS lv,
                 pv AS pv,
                 rv AS rv,
                 vst_cnt AS vst_cnt,
                 round(time_spt_f_vst)/1000 AS time_spt_f_vst,
                 bunc_rate AS bunc_rate
            from obs_m_vst_sta
           where std_ym between #{startDate} and #{endDate}
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
        <if test="sidx == 'stdDt'">
            ORDER BY std_ym ${sord}
        </if>
        <if test="sidx == 'uv'">
            ORDER BY uv ${sord}
        </if>
        <if test="sidx == 'lv'">
            ORDER BY lv ${sord}
        </if>
        <if test="sidx == 'pv'">
            ORDER BY pv ${sord}
        </if>
        <if test="sidx == 'rv'">
            ORDER BY rv ${sord}
        </if>
        <if test="sidx == 'vstCnt'">
            ORDER BY vst_cnt ${sord}
        </if>
        <if test="sidx == 'timeSptFVst'">
            ORDER BY time_spt_f_vst ${sord}
        </if>
        <if test="sidx == 'buncRate'">
            ORDER BY bunc_rate ${sord}
        </if>
    </select>

    <select id="getVisitorListForGridPerDay2" parameterType="JqGridRequest" resultType="ObsVstSta">
        WITH t AS
        (
            select std_dt, uv, lv, pv, rv, visits, "체류시간", "Bounce rate"
            from (
                select TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                       uv AS uv,
                       lv AS lv,
                       pv AS pv,
                       rv AS rv,
                       vst_cnt AS visits,
                       round(time_spt_f_vst)/1000 AS "체류시간",
                       bunc_rate AS "Bounce rate"
                  from obs_d_vst_sta
                 where std_dt between #{startDate} and #{endDate}
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
            order by std_dt
            )
        )
        select *
        from   t
        UNPIVOT (measureValue for measure in (uv, lv, pv, rv, visits, "체류시간", "Bounce rate"))
        WHERE measureValue != 0
    </select>
    <select id="getVisitorListForGridPerWeek2" parameterType="JqGridRequest" resultType="ObsVstSta">
        WITH t AS
        (
            select std_dt, uv, lv, pv, rv, visits, "체류시간", "Bounce rate"
            from (
                select TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                       uv AS uv,
                       lv AS lv,
                       pv AS pv,
                       rv AS rv,
                       vst_cnt AS visits,
                       round(time_spt_f_vst)/1000 AS "체류시간",
                       bunc_rate AS "Bounce rate"
                  from obs_w_vst_sta
                 where <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
            order by std_dt
            )
        )
        select *
        from   t
        UNPIVOT (measureValue for measure in (uv, lv, pv, rv, visits, "체류시간", "Bounce rate"))
        WHERE measureValue != 0
    </select>
    <select id="getVisitorListForGridPerMonth2" parameterType="JqGridRequest" resultType="ObsVstSta">
        WITH t AS
        (
            select std_dt, uv, lv, pv, rv, visits, "체류시간", "Bounce rate"
            from (
                select TO_CHAR(TO_DATE(std_ym,'YYYYMM'),'YYYY-MM') as std_dt,
                       uv AS uv,
                       lv AS lv,
                       pv AS pv,
                       rv AS rv,
                       vst_cnt AS visits,
                       round(time_spt_f_vst)/1000 AS "체류시간",
                       bunc_rate AS "Bounce rate"
                  from obs_m_vst_sta
                 where std_ym between #{startDate} and #{endDate}
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
            order by std_ym
            )
        )
        select *
        from   t
        UNPIVOT (measureValue for measure in (uv, lv, pv, rv, visits, "체류시간", "Bounce rate"))
        WHERE measureValue != 0
    </select>


    <select id="getVisitorListForChartPerDay" parameterType="ChartRequest" resultType="ObsVstSta">
      select   TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD') as std_dt,
               uv AS uv,
               lv AS lv,
               pv AS pv,
               rv AS rv,
               vst_cnt AS vst_cnt,
               round(time_spt_f_vst)/1000 AS time_spt_f_vst,
               bunc_rate AS bunc_rate
          from obs_d_vst_sta
         where std_dt between #{startDate} and #{endDate}
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
      order by std_dt
    </select>
    <select id="getVisitorListForChartPerWeek" parameterType="ChartRequest" resultType="ObsVstSta">
        select  TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD') as std_dt,
                uv AS uv,
                lv AS lv,
                pv AS pv,
                rv AS rv,
                vst_cnt AS vst_cnt,
                round(time_spt_f_vst)/1000 AS time_spt_f_vst,
                bunc_rate AS bunc_rate
          from obs_w_vst_sta
         where std_dt <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
      order by std_dt
    </select>
    <select id="getVisitorListForChartPerMonth" parameterType="ChartRequest" resultType="ObsVstSta">
        select  TO_CHAR(TO_DATE(std_ym,'YYYYMM'),'YYYY-MM') as std_dt,
                uv AS uv,
                lv AS lv,
                pv AS pv,
                rv AS rv,
                vst_cnt AS vst_cnt,
                round(time_spt_f_vst)/1000 AS time_spt_f_vst,
                bunc_rate AS bunc_rate
          from obs_m_vst_sta
         where std_ym between #{startDate} and #{endDate}
           <if test="pocCode != null"> AND poc_ind_cd = #{pocCode} </if>
      order by std_ym
    </select>


</mapper>
