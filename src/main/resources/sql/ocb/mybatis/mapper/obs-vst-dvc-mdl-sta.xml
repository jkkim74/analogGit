<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.ocb.ObsVstDvcMdlStaRepository">
    <select id="getVisitorsDvcMdlPerDay" parameterType="JqGridRequest" resultType="ObsVstDvcMdlSta">
        WITH t AS
                (SELECT /*+ INDEX(OBS_D_VST_DVC_MDL_STA OBS_D_VST_DVC_MDL_STA_PK) */ TO_CHAR(TO_DATE(std_dt, 'YYYYMMDD'),'YYYY-MM-DD')|| '('|| TO_CHAR(TO_DATE(std_dt, 'yyyymmdd'), 'dy')|| ')' AS std_dt,
                          '@'||dvc_mdl AS dvc_mdl,
                          uv AS uv,
                          lv AS lv,
                          pv AS pv,
                          vst_cnt AS vst_cnt
                 FROM  OBS_D_VST_DVC_MDL_STA
                 WHERE std_dt BETWEEN #{startDate} AND #{endDate}
                 AND   poc_ind_cd = '01'
                 AND   dvc_mdl > ' '
                 ORDER BY std_dt, dvc_mdl)
          SELECT std_dt,
                 dvc_mdl,
                 DECODE (measure,
                         'UV', '1UV',
                         'LV', '2LV (login visitor)',
                         'VST_CNT', '3방문횟수',
                         'PV', '4PV')
                    AS measure,
                 measure_value
            FROM t UNPIVOT (measure_value FOR measure IN (uv, lv, pv, vst_cnt))
           WHERE measure_value != 0
        ORDER BY std_dt, dvc_mdl, measure
    </select>
    <select id="getVisitorsDvcMdlPerWeek" parameterType="JqGridRequest" resultType="ObsVstDvcMdlSta">
        WITH t AS
                (SELECT /*+ INDEX(OBS_W_VST_DVC_MDL_STA OBS_W_VST_DVC_MDL_STA_PK) */ TO_CHAR (TO_DATE (std_dt, 'YYYYMMDD'),'YYYY-MM-DD')|| '('|| TO_CHAR (TO_DATE (std_dt, 'yyyymmdd'), 'dy')|| ')' AS std_dt,
                          '@'||dvc_mdl AS dvc_mdl,
                          uv AS uv,
                          lv AS lv,
                          pv AS pv,
                          vst_cnt AS vst_cnt
                 FROM  OBS_W_VST_DVC_MDL_STA
                 WHERE std_dt <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />
                 AND   poc_ind_cd = '01'
                 AND   dvc_mdl > ' '
                 ORDER BY std_dt, dvc_mdl)
          SELECT std_dt,
                 dvc_mdl,
                 DECODE (measure,
                         'UV', '1UV',
                         'LV', '2LV (login visitor)',
                         'VST_CNT', '3방문횟수',
                         'PV', '4PV')
                    AS measure,
                 measure_value
            FROM t UNPIVOT (measure_value FOR measure IN (uv, lv, pv, vst_cnt))
           WHERE measure_value != 0
        ORDER BY std_dt, dvc_mdl, measure
    </select>
    <select id="getVisitorsDvcMdlPerMonth" parameterType="JqGridRequest" resultType="ObsVstDvcMdlSta">
        WITH t AS
                (SELECT /*+ INDEX(OBS_M_VST_DVC_MDL_STA OBS_M_VST_DVC_MDL_STA_PK) */ TO_CHAR (TO_DATE (std_ym, 'YYYYMM'),'YYYY-MM') AS std_dt,
                          '@'||dvc_mdl AS dvc_mdl,
                          uv AS uv,
                          lv AS lv,
                          pv AS pv,
                          vst_cnt AS vst_cnt
                 FROM  OBS_M_VST_DVC_MDL_STA
                 WHERE std_ym BETWEEN #{startDate} AND #{endDate}
                 AND   poc_ind_cd = '01'
                 AND   dvc_mdl > ' '
                 ORDER BY std_dt, dvc_mdl)
          SELECT std_dt,
                 dvc_mdl,
                 DECODE (measure,
                         'UV', '1UV',
                         'LV', '2LV (login visitor)',
                         'VST_CNT', '3방문횟수',
                         'PV', '4PV')
                    AS measure,
                 measure_value
            FROM t UNPIVOT (measure_value FOR measure IN (uv, lv, pv, vst_cnt))
           WHERE measure_value != 0
        ORDER BY std_dt, dvc_mdl, measure
    </select>
</mapper>
