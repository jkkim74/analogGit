<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.ocb.ObsCntntTraraFlyrStaRepository">
    <sql id="whereMeasureCode">
        <where>
            <if test="measureCode == 'UV'">
                measure IN ('RCV_CNT_ON_UV', 'CLICK_CNT_ON_UV')
            </if>
            <if test="measureCode == 'LV'">
                measure IN ('RCV_CNT_ON_LV', 'CLICK_CNT_ON_LV')
            </if>
            <if test="measureCode == 'PV'">
                measure IN ('RCV_CNT_ON_PV', 'CLICK_CNT_ON_PV')
            </if>
        </where>
    </sql>

    <select id="getStoreFlyerForPivotPerDay" parameterType="JqGridRequest" resultType="ObsCntntTraraFlyrSta">
        WITH t
             AS (  SELECT
                        TO_CHAR (TO_DATE (std_dt, 'YYYYMMDD'), 'YYYY-MM-DD')|| '('|| TO_CHAR (TO_DATE (std_dt, 'yyyymmdd'), 'dy')|| ')' AS std_dt,
                        push_grp_id as push_grp_id,
                        grp_id as grp_id,
                        TO_CHAR (TO_DATE (snd_start_dt, 'YYYYMMDD'), 'YYYY.MM.DD')|| '('|| TO_CHAR (TO_DATE (snd_start_dt, 'yyyymmdd'), 'dy')|| ')' AS SND_START_DT,
                        TO_CHAR (TO_DATE (snd_end_dt, 'YYYYMMDD'), 'YYYY.MM.DD')|| '('|| TO_CHAR (TO_DATE (snd_end_dt, 'yyyymmdd'), 'dy')|| ')' AS SND_END_DT,
                        click_cnt_on_uv,
                        click_cnt_on_lv,
                        click_cnt_on_pv,
                        rcv_cnt_on_uv,
                        rcv_cnt_on_lv,
                        rcv_cnt_on_pv
                    FROM OBS_D_CNTNT_TRARA_FLYR_STA
                    WHERE
                        std_dt BETWEEN #{startDate} AND #{endDate}
                    ORDER BY push_grp_id,
                        grp_id,
                        snd_start_dt,
                        snd_end_dt)
        SELECT
            push_grp_id,
            grp_id,
            snd_start_dt,
            snd_end_dt,
            std_dt,
            DECODE (measure,
               'RCV_CNT_ON_UV', '01RCV_CNT_ON_UV',
               'RCV_CNT_ON_LV', '01RCV_CNT_ON_LV',
               'RCV_CNT_ON_PV', '01RCV_CNT_ON_PV',
               'CLICK_CNT_ON_UV', '02CLICK_CNT_ON_UV',
               'CLICK_CNT_ON_LV', '02CLICK_CNT_ON_LV',
               'CLICK_CNT_ON_PV', '02CLICK_CNT_ON_PV')
            AS measure,
            measure_value
        FROM t UNPIVOT (measure_value
            FOR measure
            in (rcv_cnt_on_uv, rcv_cnt_on_lv, rcv_cnt_on_pv, click_cnt_on_uv, click_cnt_on_lv, click_cnt_on_pv ))
       <include refid="whereMeasureCode" />
    </select>
    <select id="getStoreFlyerForPivotPerWeek" parameterType="JqGridRequest" resultType="ObsCntntTraraFlyrSta">
        WITH t
         AS (  SELECT
                    TO_CHAR (TO_DATE (std_dt, 'YYYYMMDD'), 'YYYY-MM-DD')|| '('|| TO_CHAR (TO_DATE (std_dt, 'yyyymmdd'), 'dy')|| ')' AS std_dt,
                    push_grp_id as push_grp_id,
                    grp_id as grp_id,
                    TO_CHAR (TO_DATE (snd_start_dt, 'YYYYMMDD'), 'YYYY.MM.DD')|| '('|| TO_CHAR (TO_DATE (snd_start_dt, 'yyyymmdd'), 'dy')|| ')' AS SND_START_DT,
                    TO_CHAR (TO_DATE (snd_end_dt, 'YYYYMMDD'), 'YYYY.MM.DD')|| '('|| TO_CHAR (TO_DATE (snd_end_dt, 'yyyymmdd'), 'dy')|| ')' AS SND_END_DT,
                    click_cnt_on_uv,
                    click_cnt_on_lv,
                    click_cnt_on_pv,
                    rcv_cnt_on_uv,
                    rcv_cnt_on_lv,
                    rcv_cnt_on_pv
                FROM OBS_W_CNTNT_TRARA_FLYR_STA
                WHERE
                    (std_dt <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />)
                ORDER BY push_grp_id,
                    grp_id,
                    snd_start_dt,
                    snd_end_dt)
        SELECT
            push_grp_id,
            grp_id,
            snd_start_dt,
            snd_end_dt,
            std_dt,
            DECODE (measure,
               'RCV_CNT_ON_UV', '01RCV_CNT_ON_UV',
               'RCV_CNT_ON_LV', '01RCV_CNT_ON_LV',
               'RCV_CNT_ON_PV', '01RCV_CNT_ON_PV',
               'CLICK_CNT_ON_UV', '02CLICK_CNT_ON_UV',
               'CLICK_CNT_ON_LV', '02CLICK_CNT_ON_LV',
               'CLICK_CNT_ON_PV', '02CLICK_CNT_ON_PV')
            AS measure,
            measure_value
        FROM t UNPIVOT (measure_value
             FOR measure
             IN (rcv_cnt_on_uv, rcv_cnt_on_lv, rcv_cnt_on_pv,click_cnt_on_uv, click_cnt_on_lv, click_cnt_on_pv ))
        <include refid="whereMeasureCode" />
    </select>

    <select id="getStoreFlyerForPivotPerMonth" parameterType="JqGridRequest" resultType="ObsCntntTraraFlyrSta">
        WITH t
             AS (  SELECT
                        TO_CHAR (TO_DATE (std_ym, 'YYYYMM'), 'YYYY-MM') AS std_dt,
                        push_grp_id,
                        grp_id,
                        TO_CHAR (TO_DATE (snd_start_dt, 'YYYYMMDD'), 'YYYY.MM.DD')|| '('|| TO_CHAR (TO_DATE (snd_start_dt, 'yyyymmdd'), 'dy')|| ')' AS snd_start_dt,
                        TO_CHAR (TO_DATE (snd_end_dt, 'YYYYMMDD'), 'YYYY.MM.DD')|| '('|| TO_CHAR (TO_DATE (snd_end_dt, 'yyyymmdd'), 'dy')|| ')' AS snd_end_dt,
                        click_cnt_on_uv,
                        click_cnt_on_lv,
                        click_cnt_on_pv,
                        rcv_cnt_on_uv,
                        rcv_cnt_on_lv,
                        rcv_cnt_on_pv
                    FROM OBS_M_CNTNT_TRARA_FLYR_STA
                    WHERE
                        std_ym BETWEEN #{startDate} AND #{endDate}
                    ORDER BY push_grp_id,
                        grp_id,
                        snd_start_dt,
                        snd_end_dt)
        SELECT
            push_grp_id,
            grp_id,
            snd_start_dt,
            snd_end_dt,
            std_dt,
            DECODE (measure,
               'RCV_CNT_ON_UV', '01RCV_CNT_ON_UV',
               'RCV_CNT_ON_LV', '01RCV_CNT_ON_LV',
               'RCV_CNT_ON_PV', '01RCV_CNT_ON_PV',
               'CLICK_CNT_ON_UV', '02CLICK_CNT_ON_UV',
               'CLICK_CNT_ON_LV', '02CLICK_CNT_ON_LV',
               'CLICK_CNT_ON_PV', '02CLICK_CNT_ON_PV')
            AS measure,
            measure_value
        FROM t UNPIVOT (measure_value
            FOR measure
            IN (rcv_cnt_on_uv, rcv_cnt_on_lv, rcv_cnt_on_pv,click_cnt_on_uv, click_cnt_on_lv, click_cnt_on_pv ))
        <include refid="whereMeasureCode" />
    </select>
</mapper>
