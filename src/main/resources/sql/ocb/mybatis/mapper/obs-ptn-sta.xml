<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.ocb.ObsPntStaRepository">

    <select id="getPntsPerDay" parameterType="JqGridRequest" resultType="ObsPntSta">
        WITH T AS (
              SELECT TO_CHAR (TO_DATE (std_dt, 'YYYYMMDD'),'YYYY-MM-DD')|| '('|| TO_CHAR (TO_DATE (std_dt, 'yyyymmdd'), 'dy')|| ')' AS std_dt,
                      grp_pnt_user_cnt AS grp_pnt_user_cnt,
                      grp_pnt_tot_sum AS grp_pnt_tot_sum,
                      grp_pnt_sum_p_grp_avg AS grp_pnt_sum_p_grp_avg,
                      grp_pnt_mbr_avg AS grp_pnt_mbr_avg
                 FROM obs_d_pnt_sta
                WHERE (std_dt between #{startDate} and #{endDate})
                  AND poc_ind_cd = '01'
             ORDER BY std_dt)
        SELECT std_dt,
               DECODE (
                  measure
                  ,'GRP_PNT_USER_CNT', '1같이쓰기 유저'
                  ,'GRP_PNT_TOT_SUM', '2같이쓰기 총 합산 포인트'
                  ,'GRP_PNT_SUM_P_GRP_AVG', '3같이쓰기 그룹 당 합산 포인트 평균'
                  ,'GRP_PNT_MBR_AVG', '4같이쓰기 그룹원 수 평균'
               ) AS measure,
               measure_value
          FROM t UNPIVOT (measure_value
                 FOR measure
                 IN  (grp_pnt_user_cnt
                     ,grp_pnt_tot_sum
                     ,grp_pnt_sum_p_grp_avg
                     ,grp_pnt_mbr_avg
                  ))
    </select>

    <select id="getPntsPerWeek" parameterType="JqGridRequest" resultType="ObsPntSta">
        WITH T AS (
              SELECT TO_CHAR (TO_DATE (std_dt, 'YYYYMMDD'),'YYYY-MM-DD')|| '('|| TO_CHAR (TO_DATE (std_dt, 'yyyymmdd'), 'dy')|| ')' AS std_dt,
                      grp_pnt_user_cnt AS grp_pnt_user_cnt,
                      grp_pnt_tot_sum AS grp_pnt_tot_sum,
                      grp_pnt_sum_p_grp_avg AS grp_pnt_sum_p_grp_avg,
                      grp_pnt_mbr_avg AS grp_pnt_mbr_avg
                 FROM obs_w_pnt_sta
                WHERE (std_dt  <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />)
                  AND poc_ind_cd = '01'
             ORDER BY std_dt)
        SELECT std_dt,
               DECODE (
                  measure
                  ,'GRP_PNT_USER_CNT', '1같이쓰기 유저'
                  ,'GRP_PNT_TOT_SUM', '2같이쓰기 총 합산 포인트'
                  ,'GRP_PNT_SUM_P_GRP_AVG', '3같이쓰기 그룹 당 합산 포인트 평균'
                  ,'GRP_PNT_MBR_AVG', '4같이쓰기 그룹원 수 평균'
               ) AS measure,
               measure_value
          FROM t UNPIVOT (measure_value
                 FOR measure
                 IN  (grp_pnt_user_cnt
                     ,grp_pnt_tot_sum
                     ,grp_pnt_sum_p_grp_avg
                     ,grp_pnt_mbr_avg
                  ))
    </select>


    <select id="getPntsPerMonth" parameterType="JqGridRequest" resultType="ObsPntSta">
        WITH T AS (
              SELECT TO_CHAR (TO_DATE (std_ym, 'YYYYMM'),'YYYY-MM') AS std_dt,
                      grp_pnt_user_cnt AS grp_pnt_user_cnt,
                      grp_pnt_tot_sum AS grp_pnt_tot_sum,
                      grp_pnt_sum_p_grp_avg AS grp_pnt_sum_p_grp_avg,
                      grp_pnt_mbr_avg AS grp_pnt_mbr_avg
                 FROM obs_m_pnt_sta
                WHERE (std_ym between #{startDate} and #{endDate})
                  AND poc_ind_cd = '01'
             ORDER BY std_ym)
        SELECT std_dt,
               DECODE (
                  measure
                  ,'GRP_PNT_USER_CNT', '1같이쓰기 유저'
                  ,'GRP_PNT_TOT_SUM', '2같이쓰기 총 합산 포인트'
                  ,'GRP_PNT_SUM_P_GRP_AVG', '3같이쓰기 그룹 당 합산 포인트 평균'
                  ,'GRP_PNT_MBR_AVG', '4같이쓰기 그룹원 수 평균'
               ) AS measure,
               measure_value
          FROM t UNPIVOT (measure_value
                 FOR measure
                 IN  (grp_pnt_user_cnt
                     ,grp_pnt_tot_sum
                     ,grp_pnt_sum_p_grp_avg
                     ,grp_pnt_mbr_avg
                  ))
    </select>

</mapper>
