<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.ocb.ObsSrchClickAlliStaRepository">
    <select id="getSearchResultClickAlliForPivotPerDay" parameterType="JqGridRequest" resultType="ObsSrchClickAlliSta">
        WITH k AS (
             SELECT TO_CHAR(TO_DATE(t.std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(t.std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                    MAX (t.alli_id) AS alli_id,
                    MAX (tmp.alli_nm) AS alli_nm,
                    MAX (t.alli_id) ||' '||MAX(tmp.alli_nm) AS alli_id_nm,
                    SUM (t.click_cnt) AS click_cnt,
                    RANK () OVER (PARTITION BY t.std_dt ORDER BY SUM (t.click_cnt) DESC) AS RANK
               FROM obs_d_srch_click_alli_sta t, tmp_alli_info tmp
              WHERE t.std_dt BETWEEN #{startDate} AND #{endDate}
                AND t.poc_ind_cd = '01'
                AND t.alli_id = tmp.alli_id
           GROUP BY t.std_dt, t.alli_id
           ORDER BY t.std_dt, SUM (t.click_cnt) DESC, MAX (tmp.alli_nm))
        SELECT *
          FROM k
         WHERE RANK &lt;= 100
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}, rank
        </if>
    </select>
    <select id="getSearchResultClickAlliForPivotPerWeek" parameterType="JqGridRequest" resultType="ObsSrchClickAlliSta">
        WITH k AS (
             SELECT TO_CHAR(TO_DATE(t.std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(t.std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                    MAX (t.alli_id) AS alli_id,
                    MAX (tmp.alli_nm) AS alli_nm,
                    MAX (t.alli_id) ||' '||MAX(tmp.alli_nm) AS alli_id_nm,
                    SUM (t.click_cnt) AS click_cnt,
                    RANK () OVER (PARTITION BY t.std_dt ORDER BY SUM (t.click_cnt) DESC) AS RANK
               FROM obs_w_srch_click_alli_sta t, tmp_alli_info tmp
              WHERE t.std_dt <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />
                AND t.poc_ind_cd = '01'
                AND t.alli_id = tmp.alli_id
           GROUP BY t.std_dt, t.alli_id
           ORDER BY t.std_dt, SUM (t.click_cnt) DESC, MAX (tmp.alli_nm))
        SELECT *
          FROM k
         WHERE RANK &lt;= 100
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}, rank
        </if>
    </select>
    <select id="getSearchResultClickAlliForPivotPerMonth" parameterType="JqGridRequest" resultType="ObsSrchClickAlliSta">
        WITH k AS (
             SELECT substr (t.std_ym, 0, 4) || '-' || substr (t.std_ym, 5, 2) AS std_dt,
                    MAX (t.alli_id) AS alli_id,
                    MAX (tmp.alli_nm) AS alli_nm,
                    MAX (t.alli_id) ||' '||MAX(tmp.alli_nm) AS alli_id_nm,
                    SUM (t.click_cnt) AS click_cnt,
                    RANK () OVER (PARTITION BY t.std_ym ORDER BY SUM (t.click_cnt) DESC) AS RANK
               FROM obs_m_srch_click_alli_sta t, tmp_alli_info tmp
              WHERE t.std_ym BETWEEN #{startDate} AND #{endDate}
                AND t.poc_ind_cd = '01'
                AND t.alli_id = tmp.alli_id
           GROUP BY t.std_ym, t.alli_id
           ORDER BY t.std_ym, SUM (t.click_cnt) DESC, MAX (tmp.alli_nm))
        SELECT *
          FROM k
         WHERE RANK &lt;= 100
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}, rank
        </if>
    </select>
    <select id="getSearchResultClickAlliForGridPerDay" parameterType="JqGridRequest" resultType="ObsSrchClickAlliSta">
        WITH k AS (
             SELECT TO_CHAR(TO_DATE(t.std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(t.std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                    MAX (t.alli_id) AS alli_id,
                    MAX (tmp.alli_nm) AS alli_nm,
                    SUM (t.click_cnt) AS click_cnt,
                    RANK () OVER (PARTITION BY t.std_dt ORDER BY SUM (t.click_cnt) DESC) AS RANK
               FROM obs_d_srch_click_alli_sta t, tmp_alli_info tmp
              WHERE t.std_dt BETWEEN #{startDate} AND #{endDate}
                AND t.poc_ind_cd = '01'
                AND t.alli_id = tmp.alli_id
           GROUP BY t.std_dt, t.alli_id
           ORDER BY t.std_dt, SUM (t.click_cnt) DESC, MAX (tmp.alli_nm))
        SELECT *
          FROM k
         WHERE RANK &lt;= 100
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}, rank
        </if>
    </select>
    <select id="getSearchResultClickAlliForGridPerWeek" parameterType="JqGridRequest" resultType="ObsSrchClickAlliSta">
        WITH k AS (
             SELECT TO_CHAR(TO_DATE(t.std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(t.std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                    MAX (t.alli_id) AS alli_id,
                    MAX (tmp.alli_nm) AS alli_nm,
                    SUM (t.click_cnt) AS click_cnt,
                    RANK () OVER (PARTITION BY t.std_dt ORDER BY SUM (t.click_cnt) DESC) AS RANK
               FROM obs_w_srch_click_alli_sta t, tmp_alli_info tmp
              WHERE t.std_dt <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />
                AND t.poc_ind_cd = '01'
                AND t.alli_id = tmp.alli_id
           GROUP BY t.std_dt, t.alli_id
           ORDER BY t.std_dt, SUM (t.click_cnt) DESC, MAX (tmp.alli_nm))
        SELECT *
          FROM k
         WHERE RANK &lt;= 100
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}, rank
        </if>
    </select>
    <select id="getSearchResultClickAlliForGridPerMonth" parameterType="JqGridRequest" resultType="ObsSrchClickAlliSta">
        WITH k AS (
             SELECT substr (t.std_ym, 0, 4) || '-' || substr (t.std_ym, 5, 2) AS std_dt,
                    MAX (t.alli_id) AS alli_id,
                    MAX (tmp.alli_nm) AS alli_nm,
                    SUM (t.click_cnt) AS click_cnt,
                    RANK () OVER (PARTITION BY t.std_ym ORDER BY SUM (t.click_cnt) DESC) AS RANK
               FROM obs_m_srch_click_alli_sta t, tmp_alli_info tmp
              WHERE t.std_ym BETWEEN #{startDate} AND #{endDate}
                AND t.poc_ind_cd = '01'
                AND t.alli_id = tmp.alli_id
           GROUP BY t.std_ym, t.alli_id
           ORDER BY t.std_ym, SUM (t.click_cnt) DESC, MAX (tmp.alli_nm))
        SELECT *
          FROM k
         WHERE RANK &lt;= 100
        <if test="sidx == 'stdDt'">
            ORDER BY std_dt ${sord}, rank
        </if>
    </select>
</mapper>
