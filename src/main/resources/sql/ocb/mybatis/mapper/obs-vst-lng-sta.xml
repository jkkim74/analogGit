<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.ocb.ObsVstLngStaRepository">

    <select id="getVisitorsLangPerDay" parameterType="JqGridRequest" resultType="ObsVstLngSta">
        WITH t AS
        (
            SELECT
                TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                '@'||lng_cd AS lng_cd,
                uv as uv,
                lv as lv,
                vst_cnt as vst_cnt,
                pv as pv
            FROM obs_d_vst_lng_sta
            WHERE (std_dt between #{startDate} and #{endDate})
                AND poc_ind_cd = '01'
            ORDER BY lng_cd, std_dt
        )
        SELECT std_dt, lng_cd, DECODE(measure, 'UV', '1UV', 'LV', '2LV (login visitor)','VST_CNT', '3방문횟수', 'PV', '4PV') AS measure, measure_value
        FROM   t
        UNPIVOT (measure_value FOR measure IN (uv, lv, pv, vst_cnt))
    </select>

    <select id="getVisitorsLangPerWeek" parameterType="JqGridRequest" resultType="ObsVstLngSta">
        WITH t AS
        (
            SELECT
                TO_CHAR(TO_DATE(std_dt,'YYYYMMDD'),'YYYY-MM-DD')||'('||TO_CHAR(to_Date(std_dt,'yyyymmdd'),'dy')||')' as std_dt,
                '@'||lng_cd AS lng_cd,
                uv as uv,
                lv as lv,
                vst_cnt as vst_cnt,
                pv as pv
            FROM obs_w_vst_lng_sta
            WHERE (std_dt <include refid="ObsCommonMapper.betweenStartDateAndEndDatePerWeek" />)
                AND poc_ind_cd = '01'
            ORDER BY lng_cd, std_dt
        )
        SELECT std_dt, lng_cd, DECODE(measure, 'UV', '1UV', 'LV', '2LV (login visitor)','VST_CNT', '3방문횟수', 'PV', '4PV') AS measure, measure_value
        FROM   t
        UNPIVOT (measure_value FOR measure IN (uv, lv, pv, vst_cnt))
    </select>

    <select id="getVisitorsLangPerMonth" parameterType="JqGridRequest" resultType="ObsVstLngSta">
        WITH t AS
        (
            SELECT
                substr (std_ym, 0, 4) || '-' || substr (std_ym, 5, 2) as std_dt,
                '@'||lng_cd AS lng_cd,
                uv as uv,
                lv as lv,
                vst_cnt as vst_cnt,
                pv as pv
                FROM obs_m_vst_lng_sta
            WHERE (std_ym between #{startDate} and #{endDate})
                AND poc_ind_cd = '01'
            ORDER BY lng_cd, std_ym
        )
        SELECT std_dt, lng_cd, DECODE(measure, 'UV', '1UV', 'LV', '2LV (login visitor)','VST_CNT', '3방문횟수', 'PV', '4PV') AS measure, measure_value
        FROM   t
        UNPIVOT (measure_value FOR measure IN (uv, lv, pv, vst_cnt))
    </select>

</mapper>
