<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.bip.HandInputRepository">
    <select id="getTMapCttMappInfoPerDay" parameterType="JqGridRequest" resultType="HandInput">
        SELECT sa.MAPP_STRD_DT,
                SUBSTR(sa.MAPP_STRD_DT, 1,4) ||'-'||SUBSTR(sa.MAPP_STRD_DT, 5,2)||'-'||SUBSTR(sa.MAPP_STRD_DT, 7,2) as DISP_DT,
                MAX(sa.RSLT_VAL1) as RSLT_VAL1, MAX(sa.RSLT_VAL2) as RSLT_VAL2, MAX(sa.RSLT_VAL3) as RSLT_VAL3
        FROM (
            SELECT MAPP_STRD_DT, DECODE(IDX_CL_GRP_CD, 'L017', RSLT_VAL) as RSLT_VAL1,
                    DECODE(IDX_CL_GRP_CD, 'L001',  RSLT_VAL) as RSLT_VAL2,
                    DECODE(IDX_CL_GRP_CD, 'L003',  RSLT_VAL) as RSLT_VAL3
            FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
            WHERE SVC_ID = 4
            AND IDX_CL_CD = 'M001'
            AND IDX_CTT_CD = 'S001'
            AND LNKG_CYCL_CD ='D'
            AND MAPP_STRD_DT BETWEEN #{basicDate}||'01' AND #{basicDate}||'31'
            UNION ALL
            SELECT DLY_STRD_DT as MAPP_STRD_DT, 0 as RSLT_VAL1, 0 as RSLT_VAL2, 0 as RSLT_VAL3
            FROM EISUSER.BPM_DAY_STRD_INFO
            WHERE DLY_STRD_DT BETWEEN #{basicDate}||'01' AND #{basicDate}||'31'
            ) sa
        GROUP BY MAPP_STRD_DT
        ORDER BY MAPP_STRD_DT
    </select>

    <select id="getTMapCttMappInfoPerWeek" parameterType="JqGridRequest" resultType="HandInput">
        SELECT WK_END_DT as MAPP_STRD_DT,
            TO_NUMBER(SUBSTR(WK_STC_STRD_YMW, 5,2))||'월 '||SUBSTR(WK_STC_STRD_YMW, 7,1) || '주차' ||
            '('|| SUBSTR(WK_STA_DT, 5,2) ||'/' || SUBSTR(WK_STA_DT, 7,2) || '~'
            || SUBSTR(WK_END_DT, 5,2) ||'/' || SUBSTR(WK_END_DT, 7,2)||')'  as DISP_DT,
            (
                SELECT RSLT_VAL
                FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                WHERE SVC_ID = 4
                AND IDX_CL_GRP_CD = 'L040'
                AND IDX_CL_CD = 'M001'
                AND IDX_CTT_CD = 'S001'
                AND LNKG_CYCL_CD='W'
                AND a.MAPP_STRD_DT  = b.WK_END_DT
            ) as RSLT_VAL1,
            (
                SELECT RSLT_VAL
                FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                WHERE SVC_ID = 4
                AND IDX_CL_GRP_CD = 'L046'
                AND IDX_CL_CD = 'M026'
                AND IDX_CTT_CD = 'S001'
                AND LNKG_CYCL_CD='W'
                AND a.MAPP_STRD_DT  = b.WK_END_DT
            ) as RSLT_VAL2,
            (
                SELECT RSLT_VAL
                FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                WHERE SVC_ID = 4
                AND IDX_CL_GRP_CD = 'L046'
                AND IDX_CL_CD = 'M026'
                AND IDX_CTT_CD = 'S002'
                AND LNKG_CYCL_CD='W'
                AND a.MAPP_STRD_DT  = b.WK_END_DT
            ) as RSLT_VAL3,
            (
                SELECT RSLT_VAL
                FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                WHERE SVC_ID = 4
                AND IDX_CL_GRP_CD = 'L046'
                AND IDX_CL_CD = 'M001'
                AND IDX_CTT_CD = 'S001'
                AND LNKG_CYCL_CD='W'
                AND a.MAPP_STRD_DT  = b.WK_END_DT
            ) as RSLT_VAL4
        FROM  EISUSER.BPM_WK_STRD_INFO b
        WHERE WK_STC_STRD_YMW BETWEEN #{basicDate}||'1' AND #{basicDate}||'9'
        ORDER BY WK_END_DT
    </select>
    <select id="getTMapCttMappInfoPerMonth" parameterType="JqGridRequest" resultType="HandInput">
        SELECT 	MTH_STC_STRD_YM as MAPP_STRD_DT,
                SUBSTR(MTH_STC_STRD_YM, 1,4) ||'년 '|| TO_NUMBER(SUBSTR(MTH_STC_STRD_YM, 5,2))||'월' as DISP_DT,
                (
                    SELECT RSLT_VAL
                    FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                    WHERE SVC_ID=4
                    AND IDX_CL_GRP_CD = 'L018'
                    AND IDX_CL_CD = 'M001'
                    AND IDX_CTT_CD = 'S001'
                    AND LNKG_CYCL_CD='M'
                    AND a.MAPP_STRD_DT  = b.MTH_STC_STRD_YM
                ) as RSLT_VAL1,
                (
                    SELECT RSLT_VAL
                    FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                    WHERE SVC_ID=4
                    AND IDX_CL_GRP_CD = 'L047'
                    AND IDX_CL_CD = 'M026'
                    AND IDX_CTT_CD = 'S001'
                    AND LNKG_CYCL_CD='M'
                    AND a.MAPP_STRD_DT  = b.MTH_STC_STRD_YM
                ) as RSLT_VAL2,
                (
                    SELECT RSLT_VAL
                    FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                    WHERE SVC_ID=4
                    AND IDX_CL_GRP_CD = 'L047'
                    AND IDX_CL_CD = 'M026'
                    AND IDX_CTT_CD = 'S002'
                    AND LNKG_CYCL_CD='M'
                    AND a.MAPP_STRD_DT  = b.MTH_STC_STRD_YM
                ) as RSLT_VAL3,
                (
                    SELECT RSLT_VAL
                    FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
                    WHERE SVC_ID=4
                    AND IDX_CL_GRP_CD = 'L047'
                    AND IDX_CL_CD = 'M001'
                    AND IDX_CTT_CD = 'S001'
                    AND LNKG_CYCL_CD='M'
                    AND a.MAPP_STRD_DT  = b.MTH_STC_STRD_YM
                ) as RSLT_VAL4
        FROM  EISUSER.BPM_MTH_STRD_INFO b
        WHERE MTH_STC_STRD_YM BETWEEN #{basicDate}||'01' AND #{basicDate}||'12'
        ORDER BY MTH_STC_STRD_YM
    </select>

    <select id="getSyrupCttMappInfoPerDay" parameterType="JqGridRequest" resultType="HandInput">
        SELECT  sa.MAPP_STRD_DT,
                SUBSTR(sa.MAPP_STRD_DT, 1,4) ||'-'||SUBSTR(sa.MAPP_STRD_DT, 5,2)||'-'||SUBSTR(sa.MAPP_STRD_DT, 7,2) as DISP_DT,
                MAX(sa.RSLT_VAL1) as RSLT_VAL1, MAX(sa.RSLT_VAL2) as RSLT_VAL2, MAX(sa.RSLT_VAL3) as RSLT_VAL3, MAX(sa.RSLT_VAL4) as RSLT_VAL4, MAX(sa.RSLT_VAL5) as RSLT_VAL5
        FROM (
            SELECT MAPP_STRD_DT, DECODE(IDX_CL_GRP_CD, 'L001', RSLT_VAL) RSLT_VAL1,
                    DECODE(IDX_CL_GRP_CD, 'L003',  RSLT_VAL) RSLT_VAL2,
                    DECODE(IDX_CL_GRP_CD, 'L017',  RSLT_VAL) RSLT_VAL3,
                    DECODE(IDX_CL_GRP_CD, 'L080',  RSLT_VAL) RSLT_VAL4,
                    DECODE(IDX_CL_GRP_CD, 'L081',  RSLT_VAL) RSLT_VAL5
            FROM EISUSER.BPM_IDX_CTT_MAPP_INFO a
            WHERE SVC_ID = 8
            AND IDX_CL_CD = 'M001'
            AND IDX_CTT_CD = 'S001'
            AND LNKG_CYCL_CD = 'D'
            AND MAPP_STRD_DT BETWEEN #{basicDate}||'01' AND #{basicDate}||'31'
            UNION ALL
            SELECT DLY_STRD_DT as MAPP_STRD_DT, 0 RSLT_VAL1, 0 RSLT_VAL2, 0 RSLT_VAL3, 0 RSLT_VAL4, 0 RSLT_VAL5
            FROM EISUSER.BPM_DAY_STRD_INFO
            WHERE DLY_STRD_DT BETWEEN #{basicDate}||'01' AND #{basicDate}||'31'
        ) sa
        GROUP BY MAPP_STRD_DT
        ORDER BY MAPP_STRD_DT
    </select>

    <select id="getSyrupCttMappInfoPerMonth" parameterType="JqGridRequest" resultType="HandInput">
        SELECT  sa.MAPP_STRD_DT,
                SUBSTR(sa.MAPP_STRD_DT, 1,4) ||'년 '|| TO_NUMBER(SUBSTR(sa.MAPP_STRD_DT, 5,2))||'월' as DISP_DT,
                MAX(sa.RSLT_VAL) RSLT_VAL
        FROM (
                SELECT MAPP_STRD_DT, RSLT_VAL as RSLT_VAL
                FROM   EISUSER.BPM_IDX_CTT_MAPP_INFO a
                WHERE SVC_ID = 8
                AND IDX_CL_GRP_CD = 'L018'
                AND IDX_CL_CD = 'M001'
                AND IDX_CTT_CD = 'S001'
                AND LNKG_CYCL_CD ='M'
                AND MAPP_STRD_DT BETWEEN #{basicDate}||'01' AND #{basicDate}||'12'
                UNION ALL
                SELECT MTH_STC_STRD_YM as MAPP_STRD_DT, 0 as RSLT_VAL
                FROM   EISUSER.BPM_MTH_STRD_INFO
                WHERE  MTH_STC_STRD_YM BETWEEN #{basicDate}||'01' AND #{basicDate}||'12'
            ) sa
        GROUP BY MAPP_STRD_DT
        ORDER BY MAPP_STRD_DT
    </select>

    <select id="getBatchJobCheck" parameterType="Integer" resultType="Integer">
        SELECT SUM(CNT) DATA_CNT
        FROM (
            SELECT COUNT(*) CNT
            FROM   EISUSER.BPM_MGNT_RSLT_BAT_OP_PRST A, EISUSER.BATCH_JOB_EXECUTION B
            WHERE  SVC_ID = #{svcId}
            AND    A.OPER_EXEC_ID=B.JOB_EXECUTION_ID
            AND    TO_CHAR(AUDIT_DTM,'YYYYMMDD') =TO_CHAR(SYSDATE,'YYYYMMDD')
            AND    B.EXIT_CODE ='UNKNOWN'  /** 실행중인 배치여부  **/
            UNION ALL
            SELECT COUNT(*) CNT
            FROM   EISUSER.BPM_IDX_CTT_MAPP_INFO_TMP
            WHERE  SVC_ID = #{svcId}
            AND    TO_CHAR(AUDIT_DTM,'YYYYMMDD') =TO_CHAR(SYSDATE,'YYYYMMDD')
            AND    SYSDATE - AUDIT_DTM &lt; 0.0004 /** 약30초 안에 TEMP 에 INSERT 된 데이터 여부  **/
        )
    </select>

    <delete id="deleteBpmIdxCttMappInfoTmp" parameterType="BpmIdxCttMappInfoTmp">
        DELETE FROM EISUSER.BPM_IDX_CTT_MAPP_INFO_TMP
        WHERE SVC_ID = #{svcId}
        AND TRMS_FL_NM = #{trmsFlNm}
    </delete>

    <select id="selectBpmIdxCttMappInfo" parameterType="String" resultType="BpmIdxCttMappInfo">
        SELECT MAPP_STRD_DT, SVC_ID, IDX_CL_GRP_CD, IDX_CL_CD, IDX_CTT_CD, AUDIT_ID, AUDIT_DTM, RSLT_VAL, LNKG_CYCL_CD
        FROM   EISUSER.BPM_IDX_CTT_MAPP_INFO
        WHERE  MAPP_STRD_DT= #{mappStrdDt}
        AND SVC_ID = 4
        AND IDX_CL_GRP_CD = 'L003'
        AND IDX_CL_CD = 'M001'
        AND IDX_CTT_CD = 'S001'
        AND LNKG_CYCL_CD = 'D'
    </select>

    <insert id="saveBpmIdxCttMappInfo" parameterType="BpmIdxCttMappInfo">
        MERGE INTO EISUSER.BPM_IDX_CTT_MAPP_INFO
        USING DUAL
            ON ( MAPP_STRD_DT      = #{mappStrdDt}
                 AND SVC_ID        = #{svcId}
                 AND IDX_CL_GRP_CD = #{idxClGrpCd}
                 AND IDX_CL_CD     = #{idxClCd}
                 AND IDX_CTT_CD    = #{idxCttCd}
                 )
            WHEN MATCHED THEN
        UPDATE
            SET   AUDIT_ID=#{auditId}
                , AUDIT_DTM=sysdate
                , RSLT_VAL=#{rsltVal}
        WHEN NOT MATCHED THEN
            INSERT 	( MAPP_STRD_DT
                      , SVC_ID
                      , IDX_CL_GRP_CD
                      , IDX_CL_CD
                      , IDX_CTT_CD
                      , AUDIT_ID
                      , AUDIT_DTM
                      , RSLT_VAL
                      , LNKG_CYCL_CD)
                VALUES (#{mappStrdDt}
                      , #{svcId}
                      , #{idxClGrpCd}
                      , #{idxClCd}
                      , #{idxCttCd}
                      , #{auditId}
                      , sysdate
                      , #{rsltVal}
                      , #{lnkgCyclCd})
    </insert>

    <insert id="insertBpmIdxCttMappInfoTmp" parameterType="BpmIdxCttMappInfoTmp">
        MERGE INTO EISUSER.BPM_IDX_CTT_MAPP_INFO_TMP
        USING DUAL
        ON (MAPP_STRD_DT = #{mappStrdDt}
        AND SVC_ID        = #{svcId}
        AND IDX_CL_GRP_CD = #{idxClGrpCd}
        AND IDX_CL_CD     = #{idxClCd}
        AND IDX_CTT_CD    = #{idxCttCd}
        AND TRMS_FL_NM    = #{trmsFlNm}
        )
        WHEN MATCHED THEN
            UPDATE
            SET AUDIT_ID = #{auditId}
              , AUDIT_DTM = sysdate
              , RSLT_VAL = #{rsltVal}
        WHEN NOT MATCHED THEN
            INSERT 	(
                  IDX_CTT_CD
                , IDX_CL_CD
                , IDX_CL_GRP_CD
                , SVC_ID
                , MAPP_STRD_DT
                , AUDIT_ID
                , AUDIT_DTM
                , RSLT_VAL
                , IDX_CTT_CD_DESC
                , TRMS_FL_NM
                , LNKG_CYCL_CD
                , IDX_CL_CD_GRP_NM
                , IDX_CL_CD_VAL
            )
            VALUES (
                  #{idxCttCd}
                , #{idxClCd}
                , #{idxClGrpCd}
                , #{svcId}
                , #{mappStrdDt}
                , #{auditId}
                , sysdate
                , #{rsltVal}
                , #{idxCttCdDesc}
                , #{trmsFlNm}
                , #{lnkgCyclCd}
                , #{idxClCdGrpNm, jdbcType=VARCHAR}
                , #{idxClCdVal, jdbcType=VARCHAR}
            )
    </insert>
</mapper>
