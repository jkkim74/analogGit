<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.acl.AccessLogRepository">
    <insert id="createAccessLog" parameterType="AccessLog" >
        INSERT INTO access_log (username, service_code, category_code, menu_code, ip, agent, last_update)
        VALUES (#{username}, #{serviceCode}, #{categoryCode}, #{menuCode:VARCHAR}, #{ip}, #{agent}, #{lastUpdate})
    </insert>

    <insert id="createLoginLog" parameterType="LoginLog" >
        INSERT INTO login_log (username, ip, agent, last_update)
        VALUES (#{username}, #{ip}, #{agent}, #{lastUpdate})
    </insert>

    <select id="getReportUseCount" parameterType="JqGridRequest" resultType="AccessLog">
        with t as (
            select 'UV' kind, count(*) cnt
            from (
                select distinct username
                from access_log
                where substr(username,1,2) not in ('PP')
                and substr(last_update,1,8) between #{startDate} and #{endDate})
            union all
            select 'REPORT' kind, count(*) cnt
            from (
                select distinct menu_code
                from access_log
                where substr(username,1,2) not in ('PP')
                and substr(last_update,1,8) between #{startDate} and #{endDate})
            union all
            select 'PV' kind, count(*) cnt
            from (
                select username
                from access_log
                where substr(username,1,2) not in ('PP')
                and substr(last_update,1,8) between #{startDate} and #{endDate})
        )
        select kind, cnt
        from t
      order by kind desc
    </select>

</mapper>
