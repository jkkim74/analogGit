<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.bip.BpmMthStcPrstRepository">
    <select id="getSummaryMonthlyResult" parameterType="Condition" resultType="BpmMthStcPrst">
        <foreach collection="whereConditions" item="item" separator=" UNION ALL ">
            SELECT
                a.mth_stc_strd_ym as mth_stc_strd_ym,
                a.svc_id as svc_id,
                a.idx_cl_grp_cd,
                a.idx_cl_cd,
                a.idx_ctt_cd,
                a.mth_stc_rslt_val,
                e.idx_ctt_cd_val AS "eisSvcComCd.idx_ctt_cd_val",
                e.ord_idx as ord_idx
            FROM eisuser.bpm_mth_stc_prst a
            JOIN eis_svc_com_cd e
            ON a.svc_id = e.svc_id
                AND a.idx_cl_grp_cd = e.idx_cl_grp_cd
                AND a.idx_ctt_cd = e.idx_ctt_cd
                AND a.idx_cl_cd = e.idx_cl_cd
            WHERE a.svc_id = #{item.svcId}
            AND a.idx_cl_grp_cd = #{item.idxClGrpCd}
            AND a.idx_cl_cd = #{item.idxClCd}
            AND a.idx_ctt_cd = #{item.idxCttCd}
            AND (
                    /* 13개월 전~ 기준월 */
                    a.mth_stc_strd_ym BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{searchDate}, 'YYYYMM') , -13),'YYYYMM') AND TO_CHAR(TO_DATE(#{searchDate}, 'YYYYMM'), 'YYYYMM')
                )
        </foreach>
        order by svc_id, ord_idx, mth_stc_strd_ym
    </select>

    <select id="getBpmMonthlyResultSums" parameterType="WhereCondition" resultType="BpmMthStcPrst">
        SELECT
            a.svc_id, a.idx_cl_grp_cd, a.idx_cl_cd, a.idx_ctt_cd,
            c.idx_cl_cd_grp_nm,
            DECODE(d.idx_cl_cd_val, '총계', '1'||d.idx_cl_cd_val, '2'||d.idx_cl_cd_val) AS idx_cl_cd_val,
            b.idx_ctt_cd_val,
            TO_CHAR(TO_DATE(a.mth_stc_strd_ym, 'YYYYMM'), 'YYYY/MM') || '월' mth_stc_strd_ym, a.mth_stc_rslt_val
        FROM (
            SELECT
                svc_id, idx_cl_grp_cd, idx_cl_cd, idx_ctt_cd, mth_stc_strd_ym, mth_stc_rslt_val
            FROM EISUSER.BPM_MTH_STC_PRST
            WHERE svc_id = #{svcId}
                AND mth_stc_strd_ym BETWEEN #{startDate} AND #{endDate}
                <if test="idxClGrpCd != null and idxClGrpCd != ''">
                    AND idx_cl_grp_cd = #{idxClGrpCd}
                </if>
                <if test="idxClCd != null and idxClCd != ''">
                    AND idx_cl_cd = #{idxClCd}
                </if>
            ) a, EISUSER.BPM_IDX_CTT_INFO b, EISUSER.BPM_IDX_CL_GRP_INFO c, EISUSER.BPM_IDX_CL_INFO d
        WHERE a.svc_id =  b.svc_id
            AND a.idx_cl_grp_cd =  b.idx_cl_grp_cd
            AND a.idx_cl_cd = b.idx_cl_cd
            AND a.idx_ctt_cd = b.idx_ctt_cd
            AND b.idx_cl_grp_cd = c.idx_cl_grp_cd
            AND b.idx_cl_cd = d.idx_cl_cd
        ORDER BY a.svc_id, a.idx_cl_grp_cd, a.idx_cl_cd, a.idx_ctt_cd, a.mth_stc_strd_ym
    </select>

    <select id="getBpmMthStrdInfos" parameterType="WhereCondition" resultType="BpmMthStrdInfo">
        SELECT mth_stc_strd_ym, audit_id, audit_dtm, mth_strd_val, cd_seq, mth_sta_dt, mth_end_dt
        FROM   EISUSER.BPM_MTH_STRD_INFO
        WHERE mth_stc_strd_ym >= #{startDate}
        AND   mth_stc_strd_ym &lt;= #{endDate}
    </select>
</mapper>
