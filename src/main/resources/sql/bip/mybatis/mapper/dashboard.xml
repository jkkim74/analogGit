<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.bip.DashboardRepository">
    <select id="makeDayToWeek" parameterType="String" resultType="String">
        select WK_STC_STRD_YMW AS curWeek
          from eisuser.BPM_WK_STRD_INFO
         where wk_sta_dt <![CDATA[<=]]> #{curDate} and wk_end_dt <![CDATA[>=]]> #{curDate}
    </select>
    <select id="getDashboardCategory" parameterType="WhereCondition" resultType="WhereCondition">
        WITH SVC_INFO AS (
            SELECT svc_id, svc_nm
              FROM eisuser.com_svc)
          , GRP_INFO AS (
            SELECT idx_cl_grp_cd, IDX_CL_CD_GRP_NM
              FROM eisuser.bpm_idx_cl_grp_info)
        SELECT d.CATEGORY AS category
              ,d.DATE_TYPE AS date_type
              ,d.CHART_TYPE AS chart_type
              ,d.SVC_ID AS svc_id
              ,s.SVC_NM AS svc_nm
              ,d.IDX_CL_GRP_CD AS idx_cl_grp_cd
--               ,g.IDX_CL_CD_GRP_NM AS idx_cl_cd_grp_nm
              ,CASE d.KPI_ID
                 WHEN '10002' THEN 'OCB 적립건수'
                 WHEN '10003' THEN 'OCB 사용건수'
                 WHEN '10004' THEN 'OCB 적립포인트'
                 WHEN '10005' THEN 'OCB 사용포인트'
                 ELSE g.IDX_CL_CD_GRP_NM
              END as idx_cl_cd_grp_nm
              ,d.IDX_CL_CD AS idx_cl_cd
              ,d.IDX_CTT_CD AS idx_ctt_cd
              ,d.KPI_ID AS kpi_id
              ,d.SEQ AS seq
        FROM DASHBOARD_CONFIG_NEW d, SVC_INFO s, GRP_INFO g
        WHERE d.USE_YN = 'Y'
          AND d.CATEGORY = #{category}
          AND d.DATE_TYPE = #{dateType}
        <if test="category == 'bm'.toString()">
          AND d.SVC_ID = #{svcId}
        </if>
          AND d.SVC_ID = s.SVC_ID
          AND d.IDX_CL_GRP_CD = g.IDX_CL_GRP_CD
        <choose>
          <when test="category == 'bm'.toString()">
        ORDER BY chart_type desc, SEQ
          </when>
          <otherwise>
        ORDER BY SEQ
          </otherwise>
        </choose>
    </select>

    <select id="getDashboardSparklineDataset" parameterType="Condition" resultType="BpmDlyPrst">
      <foreach collection="whereConditions" item="item" separator=" UNION ALL ">
          SELECT
        <choose>
          <when test="dateType == 'day'.toString()">
                  dly_strd_dt
          </when>
          <otherwise>
                  WK_STC_STRD_YMW AS dly_strd_dt
          </otherwise>
        </choose>
                 ,svc_id
                 ,idx_cl_grp_cd
                 ,idx_cl_cd
                 ,idx_ctt_cd
                 ,audit_id
                 ,audit_dtm
        <choose>
          <when test="dateType == 'day'.toString()">
                 ,dly_rslt_val
            FROM eisuser.bpm_dly_prst
          </when>
          <otherwise>
                 ,WK_STC_RSLT_VAL AS dly_rslt_val
            FROM eisuser.BPM_WK_STC_PRST
          </otherwise>
        </choose>
            WHERE SVC_ID = #{item.svcId}
              AND IDX_CL_GRP_CD = #{item.idxClGrpCd}
              AND IDX_CL_CD = #{item.idxClCd}
              AND IDX_CTT_CD = #{item.idxCttCd}
        <choose>
          <when test="dateType == 'day'.toString()">
            <choose>
              <when test="oneYearBefore">
                  AND dly_strd_dt between to_char(add_months(to_date(#{startDate}),-12),'yyyymmdd') and to_char(add_months(to_date(#{endDate}),-12),'yyyymmdd')
              </when>
              <otherwise>
                  AND dly_strd_dt between #{startDate} and #{endDate}
              </otherwise>
            </choose>
          </when>
          <otherwise>
            <choose>
              <when test="oneYearBefore">
                  AND WK_STC_STRD_YMW between
                    (select WK_STC_STRD_YMW from eisuser.BPM_WK_STRD_INFO where wk_sta_dt <![CDATA[<=]]> to_char(add_months(to_date(#{startDate}),-12),'yyyymmdd') and wk_end_dt <![CDATA[>=]]> to_char(add_months(to_date(#{startDate}),-12),'yyyymmdd'))
                    AND
                    (select WK_STC_STRD_YMW from eisuser.BPM_WK_STRD_INFO where wk_sta_dt <![CDATA[<=]]> to_char(add_months(to_date(#{endDate}),-12),'yyyymmdd') and wk_end_dt <![CDATA[>=]]> to_char(add_months(to_date(#{endDate}),-12),'yyyymmdd'))
              </when>
              <otherwise>
                  AND WK_STC_STRD_YMW between
                    (select WK_STC_STRD_YMW from eisuser.BPM_WK_STRD_INFO where wk_sta_dt <![CDATA[<=]]> #{startDate} and wk_end_dt <![CDATA[>=]]> #{startDate})
                    AND
                    (select WK_STC_STRD_YMW from eisuser.BPM_WK_STRD_INFO where wk_sta_dt <![CDATA[<=]]> #{endDate} and wk_end_dt <![CDATA[>=]]> #{endDate})
              </otherwise>
            </choose>
          </otherwise>
        </choose>

      </foreach>
         ORDER BY idx_cl_grp_cd, svc_id, dly_strd_dt
    </select>

    <select id="getDashboardSparklinePast7DayDataset" parameterType="WhereCondition" resultType="BpmDlyPrst">
          SELECT  dly_strd_dt
                 ,svc_id
                 ,idx_cl_grp_cd
                 ,idx_cl_cd
                 ,idx_ctt_cd
                 ,audit_id
                 ,audit_dtm
                 ,dly_rslt_val
            FROM eisuser.bpm_dly_prst
            WHERE SVC_ID = #{svcId}
              AND IDX_CL_GRP_CD = #{idxClGrpCd}
              AND IDX_CL_CD = #{idxClCd}
              AND IDX_CTT_CD = #{idxCttCd}
              AND dly_strd_dt between #{startDate} and #{endDate}
         ORDER BY idx_cl_grp_cd, svc_id, dly_strd_dt
    </select>
</mapper>
