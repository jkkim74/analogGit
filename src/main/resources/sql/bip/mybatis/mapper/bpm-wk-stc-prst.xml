<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.bip.BpmWkStcPrstRepository">
    <sql id="selectBpmWkStrdInfo">
        SELECT wk_stc_strd_ymw, audit_id, audit_dtm, wk_strd_val, cd_seq, wk_sta_dt, wk_end_dt
        FROM   EISUSER.BPM_WK_STRD_INFO
    </sql>
    <select id="getSummaryWeeklyResult" parameterType="Condition" resultType="BpmWkStcPrst">
        <foreach collection="whereConditions" item="item" separator=" UNION ALL ">
            SELECT
                a.wk_stc_strd_ymw as wk_stc_strd_ymw,
                a.svc_id as svc_id,
                a.idx_cl_grp_cd,
                a.idx_cl_cd,
                a.idx_ctt_cd,
                a.aply_sta_dt,
                a.aply_end_dt,
                a.wk_stc_rslt_val,
                e.idx_ctt_cd_val as "eisSvcComCd.idx_ctt_cd_val",
                e.ord_idx as ord_idx
            FROM eisuser.bpm_wk_stc_prst a
            JOIN eis_svc_com_cd e
                ON a.svc_id = e.svc_id
                AND a.idx_cl_grp_cd = e.idx_cl_grp_cd
                AND a.idx_ctt_cd = e.idx_ctt_cd
                AND a.idx_cl_cd = e.idx_cl_cd
            WHERE a.svc_id = #{item.svcId}
            AND a.idx_cl_grp_cd = #{item.idxClGrpCd}
            AND a.idx_cl_cd = #{item.idxClCd}
            AND a.idx_ctt_cd = #{item.idxCttCd}
            AND (
                    /* 14주전, 1년전*/
                    (a.wk_stc_strd_ymw &gt;= #{startWeekNumber} AND a.wk_stc_strd_ymw &lt;= #{endWeekNumber})
                     OR a.wk_stc_strd_ymw = #{oneYearAgoWeekNumber}
                 )
        </foreach>
        order by svc_id, ord_idx, wk_stc_strd_ymw
    </select>
    <select id="getBpmWeeklyResultSums" parameterType="WhereCondition" resultType="BpmWkStcPrst">
        SELECT
            a.svc_id, a.idx_cl_grp_cd, a.idx_cl_cd, a.idx_ctt_cd,
            c.idx_cl_cd_grp_nm,
            DECODE(d.idx_cl_cd_val, '총계', '1'||d.idx_cl_cd_val, '2'||d.idx_cl_cd_val) AS idx_cl_cd_val,
            b.idx_ctt_cd_val,
            SUBSTR(a.wk_stc_strd_ymw, 1,4)||'/'||a.wk_strd_val as wk_strd_val, a.wk_stc_rslt_val
        FROM (
            SELECT aa.svc_id, aa.idx_cl_grp_cd, aa.idx_cl_cd, aa.idx_ctt_cd, aa.wk_stc_strd_ymw, aa.wk_stc_rslt_val, bb.wk_strd_val
            FROM EISUSER.BPM_WK_STC_PRST aa, EISUSER.BPM_WK_STRD_INFO bb
            WHERE
                aa.wk_stc_strd_ymw = bb.wk_stc_strd_ymw
                AND aa.svc_id= #{svcId}
                AND aa.wk_stc_strd_ymw BETWEEN #{startWeekNumber} AND #{endWeekNumber}
                <if test="idxClGrpCd != null and idxClGrpCd != ''">
                    AND idx_cl_grp_cd = #{idxClGrpCd}
                </if>
                <if test="idxClCd != null and idxClCd != ''">
                    AND idx_cl_cd = #{idxClCd}
                </if>
            ) a, EISUSER.BPM_IDX_CTT_INFO b, EISUSER.BPM_IDX_CL_GRP_INFO c, EISUSER.BPM_IDX_CL_INFO d
        WHERE a.svc_id =  b.svc_id
            AND a.idx_cl_grp_cd =  b.idx_cl_grp_cd
            AND a.idx_cl_cd = b.idx_cl_cd
            AND a.idx_ctt_cd = b.idx_ctt_cd
            AND b.idx_cl_grp_cd = c.idx_cl_grp_cd
            AND b.idx_cl_cd = d.idx_cl_cd
		    AND c.lnkg_cycl_cd = 'D'
        ORDER BY a.svc_id, a.idx_cl_grp_cd, a.idx_cl_cd, a.idx_ctt_cd, a.wk_stc_strd_ymw
    </select>
    <select id="getBpmWkStrdInfo" parameterType="WhereCondition" resultType="BpmWkStrdInfo">
        <include refid="selectBpmWkStrdInfo" />
        WHERE wk_sta_dt &lt;= TO_CHAR(TO_DATE(#{searchDate}, 'YYYYMMDD'), 'YYYYMMDD')
        AND   wk_end_dt &gt;= TO_CHAR(TO_DATE(#{searchDate}, 'YYYYMMDD'), 'YYYYMMDD')
    </select>

    <select id="getWeekAgoBpmWkStrdInfo" parameterType="WhereCondition" resultType="BpmWkStrdInfo">
        <include refid="selectBpmWkStrdInfo" />
        WHERE (wk_sta_dt &lt;= TO_CHAR(TO_DATE(#{searchDate}, 'YYYYMMDD') - 7 * #{searchDiff}, 'YYYYMMDD')
        AND   wk_end_dt &gt;= TO_CHAR(TO_DATE(#{searchDate}, 'YYYYMMDD') - 7 * #{searchDiff}, 'YYYYMMDD') )
    </select>

    <select id="getWeeksAgoBpmWkStrdInfo" parameterType="WhereCondition" resultType="BpmWkStrdInfo">
        <include refid="selectBpmWkStrdInfo" />
        WHERE  wk_stc_strd_ymw >= (
        SELECT w1.wk_stc_strd_ymw
        FROM   eisuser.bpm_wk_strd_info w1
        WHERE  w1.wk_sta_dt &lt;= TO_CHAR(TO_DATE(#{searchDate}, 'YYYYMMDD') - 7 * #{searchDiff}, 'YYYYMMDD')
        AND    w1.wk_end_dt >= TO_CHAR (TO_DATE(#{searchDate}, 'YYYYMMDD') - 7 * #{searchDiff}, 'YYYYMMDD'))
        AND    wk_stc_strd_ymw &lt;= (
        SELECT w2.wk_stc_strd_ymw
        FROM   eisuser.bpm_wk_strd_info w2
        WHERE  w2.wk_sta_dt &lt;= #{searchDate}
        AND    w2.wk_end_dt >= #{searchDate})
        ORDER BY wk_stc_strd_ymw asc
    </select>

    <select id="getOneYearAgoBpmWkStrdInfo" parameterType="WhereCondition" resultType="BpmWkStrdInfo">
        <include refid="selectBpmWkStrdInfo" />
        WHERE (wk_sta_dt &lt;= TO_CHAR(ADD_MONTHS(TO_DATE(#{searchDate}, 'YYYYMMDD') , -12),'YYYYMMDD')
        AND   wk_end_dt  &gt;=  TO_CHAR(ADD_MONTHS(TO_DATE(#{searchDate}, 'YYYYMMDD') , -12),'YYYYMMDD') )
    </select>
</mapper>
