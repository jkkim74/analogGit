<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.bip.DssRepository">
    <resultMap id="DetailDssResult" type="Dss">
        <result property="id" column="id"/>
        <association property="createUser" javaType="BipUser" column="create_id" select="com.skplanet.bisportal.repository.acl.UserRepository.getBipUser" />
        <collection property="bmList" javaType="ArrayList" column="id" ofType="DssBmList" select="com.skplanet.bisportal.repository.bip.DssBmListRepository.getDssBmList"/>
    </resultMap>

    <select id="getDss" parameterType="long" resultMap="DetailDssResult">
        SELECT
            ID,
            SUBJECT,
            CONTENT,
            CONCLUSION,
            FUTURE_WORK,
            DATA_SOURCE,
            SAMPLE_SIZE,
            VARIABLE AS variablesJSON,
            ANALYSIS_START,
            ANALYSIS_END,
            DATA_START,
            DATA_END,
            CREATE_ID,
            CREATE_DATE
        FROM
            DSS
        WHERE
            DELETE_YN = 'N'
            AND ID = #{dssId}
    </select>

    <select id="getLatestDss" resultMap="DetailDssResult">
        WITH t AS (
            SELECT
              ID,
              SUBJECT,
              CONTENT,
              CONCLUSION,
              FUTURE_WORK,
              DATA_SOURCE,
              SAMPLE_SIZE,
              VARIABLE AS variablesJSON,
              ANALYSIS_START,
              ANALYSIS_END,
              DATA_START,
              DATA_END,
              CREATE_ID,
              CREATE_DATE
            FROM
              DSS
            WHERE
              DELETE_YN = 'N'
              AND ROWNUM <![CDATA[<=]]> 5
            ORDER BY id DESC
        ),
        t2 AS (
          SELECT *
          FROM t
          ORDER BY DBMS_RANDOM.RANDOM
        )
        SELECT *
        FROM t2
        WHERE rownum = 1
    </select>

    <select id="getDssList" parameterType="DssRequest" resultMap="DetailDssResult">
        SELECT
            ID,
            SUBJECT,
            CONTENT,
            CONCLUSION,
            FUTURE_WORK,
            DATA_SOURCE,
            SAMPLE_SIZE,
            VARIABLE,
            ANALYSIS_START,
            ANALYSIS_END,
            DATA_START,
            DATA_END,
            VIEW_COUNT,
            CREATE_ID,
            CREATE_DATE
        FROM
            (
            SELECT
                a.*,
                ROWNUM rnum,
                FLOOR((ROWNUM - 1) / #{pageSize} + 1) AS PAGE
            FROM
                (
                SELECT
                    a.*
                FROM
                    DSS a
                <!-- bm 타입으로 검색 -->
                <if test="bms != null and bms != ''">
                    , (select dss_id from dss_bm_list where delete_yn = 'N' AND bm_id in
                    <foreach collection="bmList" item="bm" separator="," open="(" close=")">
                        #{bm}
                    </foreach>
                    ) b
                </if>
                <!-- 작성자 명으로 검색 -->
                <if test="createName != null and createName != ''">
                    , (SELECT USERNAME FROM BIP_USER WHERE FULLNAME = #{createName}) c
                </if>
                WHERE
                    DELETE_YN = 'N'
                <!-- 작성자 명으로 검색 -->
                <if test="bms != null and bms != ''">
                    AND a.id = b.dss_id
                </if>
                <!-- 등록 일자로 검색 -->
                <if test="searchStart != null and searchStart != ''">
                    AND a.create_date BETWEEN #{searchStart} AND #{searchEnd}
                </if>
                <!-- 작성자 명으로 검색 -->
                <if test="createName != null and createName != ''">
                    AND a.create_id = c.username
                </if>
                <!-- 내용으로 검색 -->
                <if test="content != null and content != ''">
                    <choose>
                        <when test="contentType == 'all'">
                            AND (subject like '%'||#{content}||'%' OR content like '%'||#{content}||'%')
                        </when>
                        <when test="contentType == 'subject'">
                            AND subject like '%'||#{content}||'%'
                        </when>
                        <when test="contentType == 'content'">
                            AND content like '%'||#{content}||'%'
                        </when>
                    </choose>
                </if>
                <!-- 정렬 -->
                <choose>
                    <when test="orderBy == 'viewCount'">
                        ORDER BY a.view_count DESC
                    </when>
                    <otherwise>
                        ORDER BY a.create_date DESC
                    </otherwise>
                </choose>
                ) a
            ) a
        WHERE
            a.PAGE = #{page}
            OR a.rnum = ${page} * ${pageSize} + 1
    </select>

    <select id="hasNext" parameterType="DssRequest" resultType="int">
        SELECT
            CASE
              WHEN count(*) - #{pageSize} * #{page} > 0 then 1
              ELSE 0
            END hasNext
        FROM
            DSS a
            <!-- bm 타입으로 검색 -->
            <if test="bms != null and bms != ''">
                , (select dss_id from dss_bm_list where delete_yn = 'N' AND bm_id in
                <foreach collection="bmList" item="bm" separator="," open="(" close=")">
                    #{bm}
                </foreach>
                ) b
            </if>
            <!-- 작성자 명으로 검색 -->
            <if test="createName != null and createName != ''">
                , (SELECT USERNAME FROM BIP_USER WHERE FULLNAME = #{createName}) c
            </if>
        WHERE
        DELETE_YN = 'N'
        <!-- 작성자 명으로 검색 -->
        <if test="bms != null and bms != ''">
            AND a.id = b.dss_id
        </if>
        <!-- 등록 일자로 검색 -->
        <if test="searchStart != null and searchStart != ''">
            AND a.create_date BETWEEN #{searchStart} AND #{searchEnd}
        </if>
        <!-- 작성자 명으로 검색 -->
        <if test="createName != null and createName != ''">
            AND a.create_id = c.username
        </if>
        <!-- 내용으로 검색 -->
        <if test="content != null and content != ''">
            <choose>
                <when test="contentType == 'all'">
                    AND (subject like '%'||#{content}||'%' OR content like '%'||#{content}||'%')
                </when>
                <when test="contentType == 'subject'">
                    AND subject like '%'||#{content}||'%'
                </when>
                <when test="contentType == 'content'">
                    AND content like '%'||#{content}||'%'
                </when>
            </choose>
        </if>
    </select>


    <select id="getNextDss" parameterType="long" resultType="Dss">
    <![CDATA[
        SELECT
            ID,
            SUBJECT,
            CONTENT,
            CONCLUSION,
            FUTURE_WORK,
            DATA_SOURCE,
            SAMPLE_SIZE,
            VARIABLE AS variablesJSON,
            ANALYSIS_START,
            ANALYSIS_END,
            DATA_START,
            DATA_END,
            CREATE_ID,
            CREATE_DATE
        FROM
            (
            SELECT
                ROWNUM RNUM,
                a.*
            FROM
                (
                SELECT
                    *
                FROM
                    DSS
                WHERE
                    DELETE_YN = 'N'
                    AND id > #{dssId}
                ORDER BY id asc
                ) a
            )
        WHERE
            RNUM = 1
    ]]>
    </select>

    <select id="getPreviousDss" parameterType="long" resultType="Dss">
    <![CDATA[
        SELECT
            ID,
            SUBJECT,
            CONTENT,
            CONCLUSION,
            FUTURE_WORK,
            DATA_SOURCE,
            SAMPLE_SIZE,
            VARIABLE AS variablesJSON,
            ANALYSIS_START,
            ANALYSIS_END,
            DATA_START,
            DATA_END,
            CREATE_ID,
            CREATE_DATE
        FROM
            (
            SELECT
                ROWNUM RNUM,
                a.*
            FROM
                (
                SELECT
                    *
                FROM
                    DSS
                WHERE
                    DELETE_YN = 'N'
                    AND id < #{dssId}
                ORDER BY id desc
                ) a
            )
        WHERE
        RNUM = 1
    ]]>
    </select>

    <insert id="addDss" parameterType="Dss">
        <selectKey keyProperty="id" resultType="long" order="BEFORE">
            select DSS_SEQ.nextval from dual
        </selectKey>
        INSERT INTO DSS
            (
            ID,
            SUBJECT,
            CONTENT,
            CONCLUSION,
            FUTURE_WORK,
            DATA_SOURCE,
            SAMPLE_SIZE,
            VARIABLE,
            ANALYSIS_START,
            ANALYSIS_END,
            DATA_START,
            DATA_END,
            CREATE_ID,
            CREATE_DATE
            )
        VALUES
            (
            ${id},
            #{subject},
            #{content},
            #{conclusion, jdbcType=CLOB},
            #{futureWork, jdbcType=CLOB},
            #{dataSource},
            #{sampleSize},
            #{variablesJSON, jdbcType=VARCHAR},
            #{analysisStartYYYYMMDD},
            #{analysisEndYYYYMMDD},
            #{dataStartYYYYMMDD},
            #{dataEndYYYYMMDD},
            #{createId},
            to_char(sysdate,'YYYYMMDDHH24MISS')
            )
    </insert>

    <update id="updateDss" parameterType="Dss">
        UPDATE DSS
        SET
            SUBJECT = #{subject},
            CONTENT = #{content},
            CONCLUSION = #{conclusion, jdbcType=CLOB},
            FUTURE_WORK = #{futureWork, jdbcType=CLOB},
            DATA_SOURCE = #{dataSource},
            SAMPLE_SIZE = #{sampleSize},
            VARIABLE = #{variablesJSON, jdbcType=VARCHAR},
            ANALYSIS_START = #{analysisStartYYYYMMDD},
            ANALYSIS_END = #{analysisEndYYYYMMDD},
            DATA_START = #{dataStartYYYYMMDD},
            DATA_END = #{dataEndYYYYMMDD},
            UPDATE_ID = #{updateId},
            UPDATE_DATE = to_char(sysdate,'YYYYMMDDHH24MISS')
        WHERE
            DELETE_YN = 'N'
            AND ID = #{id}
    </update>

    <update id="deleteDss" parameterType="java.util.Map">
        UPDATE DSS SET
            DELETE_YN = 'Y',
            UPDATE_DATE = to_char(sysdate,'YYYYMMDDHH24MISS'),
            UPDATE_ID = #{deleteId}
        WHERE
            DELETE_YN = 'N'
            AND ID = #{dssId}
    </update>



    <update id="increaseViewCount" parameterType="Long">
        UPDATE DSS
        SET
          view_count = view_count +  1
        WHERE
          delete_yn = 'N'
          AND id = #{dssId}
    </update>
</mapper>
