<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.ctas.repository.querycache.QueryCacheRepository">

	<update id="createTargetingTable" parameterType="map">
		CREATE TABLE IF NOT EXISTS USER_${username}.WEB_TRGT_${cmpgnId} (
			MBR_ID STRING
		)
		ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
		STORED AS TEXTFILE
	</update>
	<update id="createTargetingTable" parameterType="map" databaseId="hsql">
		CREATE TABLE IF NOT EXISTS WEB_TRGT_${cmpgnId} (
			MBR_ID VARCHAR(50)
		)
	</update>

	<insert id="insertTargeting" parameterType="map">
		INSERT OVERWRITE TABLE USER_${username}.WEB_TRGT_${cmpgnId}
		<include refid="selectTargeting" />
	</insert>
	<insert id="insertTargeting" parameterType="map" databaseId="hsql">
		INSERT INTO WEB_TRGT_${cmpgnId}
		<include refid="selectTargeting" />
	</insert>

	<sql id="selectTargeting">
		SELECT MBR_ID
		FROM MART_MBR_TGTNG_MST
		<include refid="selectTargeting_where" />
	</sql>
	
	<sql id="selectTargeting_where">
		<where>
			<if test="true">AND OCB_MKTNG_AGRMT_YN = '1'  </if>
			<if test="gndrFgCd != null and gndrFgCd != ''">AND GNDR_FG_CD = #{gndrFgCd}  </if>
			<if test="age != null and age != ''">
				<foreach collection="age.split('-')" item="item" open="AND AGE BETWEEN" separator="AND"> TO_NUMBER(#{item}) </foreach>
			</if>
			<if test="homeHjdLgrpCd != null and homeHjdLgrpCd != ''">AND HOME_HJD_LGRP_CD = #{homeHjdLgrpCd} </if>
			<if test="homeHjdMgrpCd != null and homeHjdMgrpCd != ''">AND HOME_HJD_MGRP_CD = #{homeHjdMgrpCd} </if>
			<if test="jobpHjdLgrpCd != null and jobpHjdLgrpCd != ''">AND JOBP_HJD_LGRP_CD = #{jobpHjdLgrpCd} </if>
			<if test="jobpHjdMgrpCd != null and jobpHjdMgrpCd != ''">AND JOBP_HJD_MGRP_CD = #{jobpHjdMgrpCd} </if>
			<if test="mrrgYn != null and mrrgYn != ''">AND MRRG_YN = #{mrrgYn} </if>
			<if test="emailRcvAgrmtYn != null and emailRcvAgrmtYn != ''">AND EMAIL_RCV_AGRMT_YN = #{emailRcvAgrmtYn} </if>
			<if test="advtSmsRcvAgrmtYn != null and advtSmsRcvAgrmtYn != ''">AND ADVT_SMS_RCV_AGRMT_YN = #{advtSmsRcvAgrmtYn} </if>
			<if test="ifrmtSmsRcvAgrmtYn != null and ifrmtSmsRcvAgrmtYn != ''">AND IFRMT_SMS_RCV_AGRMT_YN = #{ifrmtSmsRcvAgrmtYn} </if>
			<if test="pushRcvAgrmtYn != null and pushRcvAgrmtYn != ''">AND PUSH_RCV_AGRMT_YN = #{pushRcvAgrmtYn} </if>
			<if test="bnftMlfPushAgrmtYn != null and bnftMlfPushAgrmtYn != ''">AND BNFT_MLF_PUSH_AGRMT_YN = #{bnftMlfPushAgrmtYn} </if>
			<if test="pntUseRsvngPushAgrmtYn != null and pntUseRsvngPushAgrmtYn != ''">AND PNT_USE_RSVNG_PUSH_AGRMT_YN = #{pntUseRsvngPushAgrmtYn} </if>
			<if test="tusePushAgrmtYn != null and tusePushAgrmtYn != ''">AND TUSE_PUSH_AGRMT_YN = #{tusePushAgrmtYn} </if>
			<if test="coinNotiPushAgrmtYn != null and coinNotiPushAgrmtYn != ''">AND COIN_NOTI_PUSH_AGRMT_YN = #{coinNotiPushAgrmtYn} </if>
			<if test="locUtlzAgrmtYn != null and locUtlzAgrmtYn != ''">AND LOC_UTLZ_AGRMT_YN = #{locUtlzAgrmtYn} </if>
			<if test="mlfShpAgrmtYn != null and mlfShpAgrmtYn != ''">AND MLF_SHP_AGRMT_YN = #{mlfShpAgrmtYn} </if>
			<if test="mlfTrdareaAgrmtYn != null and mlfTrdareaAgrmtYn != ''">AND MLF_TRDAREA_AGRMT_YN = #{mlfTrdareaAgrmtYn} </if>
			<if test="ocbcomJoinYn != null and ocbcomJoinYn != ''">
				<if test="ocbcomJoinYn == 'U'">AND OCBCOM_JOIN_YN = 1 AND OCBCOM_MTH07_FNL_LGN_DT = '99990101' </if>
				<if test="ocbcomJoinYn != 'U'">AND OCBCOM_JOIN_YN = #{ocbcomJoinYn} </if>
			</if>
			<if test="ocbAppJoinYn != null and ocbAppJoinYn != ''">
				<if test="ocbAppJoinYn == 'U'">AND OCB_APP_JOIN_YN = 1 AND OCB_APP_MTH07_FNL_USE_DT = '99990101' </if>
				<if test="ocbcomJoinYn != 'U'">AND OCB_APP_JOIN_YN = #{ocbAppJoinYn} </if>
			</if>
			<if test="ocbPlusJoinYn != null and ocbPlusJoinYn != ''">
				<if test="ocbPlusJoinYn == 'U'">AND OCB_PLUS_JOIN_YN = 1 AND OCB_PLUS_MTH07_FNL_YACHV_DT = '99990101' </if>
				<if test="ocbPlusJoinYn != 'U'">AND OCB_PLUS_JOIN_YN = #{ocbPlusJoinYn} </if>
			</if>
			<if test="seg629Cd != null and seg629Cd != ''">AND SEG_629_CD = #{seg629Cd} </if>
			<if test="trfcSegCd != null and trfcSegCd != ''">AND TRFC_SEG_CD = #{trfcSegCd} </if>
			<if test="ocbcomMth07FnlLgnDt != null and ocbcomMth07FnlLgnDt != ''">AND OCBCOM_MTH07_FNL_LGN_DT &gt;= #{ocbcomMth07FnlLgnDt} </if>
			<if test="ocbAppMth07FnlUseDt != null and ocbAppMth07FnlUseDt != ''">AND OCB_APP_MTH07_FNL_USE_DT &gt;= #{ocbAppMth07FnlUseDt} </if>
			<if test="appAtdcMth07FnlUseDt != null and appAtdcMth07FnlUseDt != ''">AND APP_ATDC_MTH07_FNL_USE_DT &gt;= #{appAtdcMth07FnlUseDt} </if>
			<if test="rletMth07FnlUseDt != null and rletMth07FnlUseDt != ''">AND RLET_MTH07_FNL_USE_DT &gt;= #{rletMth07FnlUseDt} </if>
			<if test="gameMth07FnlUseDt != null and gameMth07FnlUseDt != ''">AND GAME_MTH07_FNL_USE_DT &gt;= #{gameMth07FnlUseDt} </if>
			<if test="ocbPlusMth07FnlYachvDt != null and ocbPlusMth07FnlYachvDt != ''">AND OCB_PLUS_MTH07_FNL_YACHV_DT &gt;= #{ocbPlusMth07FnlYachvDt} </if>
			<if test="lckrMth07FnlYachvDt != null and lckrMth07FnlYachvDt != ''">AND LCKR_MTH07_FNL_YACHV_DT &gt;= #{lckrMth07FnlYachvDt} </if>
			<if test="mzmMth07FnlYachvDt != null and mzmMth07FnlYachvDt != ''">AND MZM_MTH07_FNL_YACHV_DT &gt;= #{mzmMth07FnlYachvDt} </if>
			<if test="azmMth07FnlYachvDt != null and azmMth07FnlYachvDt != ''">AND AZM_MTH07_FNL_YACHV_DT &gt;= #{azmMth07FnlYachvDt} </if>
			<if test="prdLflMth07FnlYachvDt != null and prdLflMth07FnlYachvDt != ''">AND PRD_LFL_MTH07_FNL_YACHV_DT &gt;= #{prdLflMth07FnlYachvDt} </if>
			<if test="mblCardPossYn != null and mblCardPossYn != ''">AND MVL_CARD_POSS_YN = #{mblCardPossYn} </if>
			<if test="skpCardPossYn != null and skpCardPossYn != ''">AND SKP_CARD_POSS_YN = #{skpCardPossYn} </if>
			<if test="crdtCardPossYn != null and crdtCardPossYn != ''">AND CRDT_CARD_POSS_YN = #{crdtCardPossYn} </if>
			<if test="chkcrdPossYn != null and chkcrdPossYn != ''">AND CHKCRD_POSS_YN = #{chkcrdPossYn} </if>
			<if test="cmncnCardPossYn != null and cmncnCardPossYn != ''">AND CMNCN_CARD_POSS_YN = #{cmncnCardPossYn} </if>
			<if test="encleanBnsCardPossYn != null and encleanBnsCardPossYn != ''">AND ENCLEAN_BNS_CARD_POSS_YN = #{encleanBnsCardPossYn} </if>
			<if test="freiWlfrCardPossYn != null and freiWlfrCardPossYn != ''">AND FREI_WLFR_CARD_POSS_YN = #{freiWlfrCardPossYn} </if>
			<if test="rflExcsCardPossYn != null and rflExcsCardPossYn != ''">AND RFL_EXCS_CARD_POSS_YN = #{rflExcsCardPossYn} </if>
			<if test="rflMth07FnlYachvDt != null and rflMth07FnlYachvDt != ''">AND RFL_MTH07_FNL_YACHV_DT &gt;= #{rflMth07FnlYachvDt} </if>
			<if test="cmncnMth07FnlYachvDt != null and cmncnMth07FnlYachvDt != ''">AND CMNCN_MTH07_FNL_YACHV_DT &gt;= #{cmncnMth07FnlYachvDt} </if>
			<if test="fncMth07FnlYachvDt != null and fncMth07FnlYachvDt != ''">AND FNC_MTH07_FNL_YACHV_DT &gt;= #{fncMth07FnlYachvDt} </if>
			<if test="etcMth07FnlYachvDt != null and etcMth07FnlYachvDt != ''">AND ETC_MTH07_FNL_YACHV_DT &gt;= #{etcMth07FnlYachvDt} </if>
			<if test="onlnMth07FnlYachvDt != null and onlnMth07FnlYachvDt != ''">AND ONLN_MTH07_FNL_YACHV_DT &gt;= #{onlnMth07FnlYachvDt} </if>
			<if test="onlnMth07CpnFnlYachvDt != null and onlnMth07CpnFnlYachvDt != ''">AND ONLN_MTH07_CPN_FNL_YACHV_DT &gt;= #{onlnMth07CpnFnlYachvDt} </if>
			<if test="avlPnt != null and avlPnt != ''">
				<foreach collection="avlPnt.split('-')" item="item" open="AND AVL_PNT BETWEEN" separator="AND"> TO_NUMBER(#{item}) </foreach>
			</if>
		</where>
	</sql>

	<select id="countTargeting" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM USER_${username}.WEB_TRGT_${cmpgnId}
	</select>
	<select id="countTargeting" parameterType="map" resultType="int" databaseId="hsql">
		SELECT COUNT(*) FROM WEB_TRGT_${cmpgnId}
	</select>

</mapper>
