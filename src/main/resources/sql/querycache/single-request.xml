<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.pandora.repository.querycache.QueryCacheRepository">

	<select id="selectTrSingleRequest" parameterType="SingleReq" resultType="AutoMap">
        SELECT A.RCV_DT AS RCV_DT                    			-- 접수일자
	        , A.APPR_DTTM AS APPR_DTTM               			-- 승인일시
	        , A.REP_APPR_NO AS REP_APPR_NO          			-- 대표승인번호
	        , A.APPR_NO AS APPR_NO                   				-- 승인번호
	        , A.SALE_DTTM AS SALE_DTTM               			-- 매출일시
	        , A.MBR_ID AS MBR_ID                     					-- 회원ID
	        , A.CARD_DTL_GRP_CD AS CARD_DTL_GRP_CD		-- 카드코드
	        ,  G.DTL_CD_NM AS DTL_CD_NM               			-- 카드코드명
	        <choose>
	        	<when test="ptsMasking == 'true'">
		            , CASE WHEN N.CARD_NO IS NULL THEN N.CARD_NO
		                 ELSE CONCAT(SUBSTRING(N.CARD_NO,1,LENGTH(N.CARD_NO)-8) , '****', SUBSTRING(N.CARD_NO,LENGTH(N.CARD_NO)-3,4) )
		              END AS CARD_NO
	          	</when>
	          	<otherwise>
	            	, N.CARD_NO AS CARD_NO               			-- 카드번호
	          	</otherwise>
			</choose>
			, A.STLMT_ALCMPN_CD AS STLMT_ALCMPN_CD   	-- 정산제휴사코드
	        , B.ALCMPN_NM AS ALCMPN_NM       					-- 정산제휴사명
	        , A.STLMT_MCNT_CD AS STLMT_MCNT_CD       	-- 정산가맹점코드
	        , C.MCNT_NM AS MCNT_NM   								-- 정산가맹점명
	        , A.ALCMPN_CD AS ALCMPN_CD       					-- 발생제휴사코드
	        , D.ALCMPN_NM AS ALCMPN_NM2      					-- 발생제휴사명
	        , A.MCNT_CD AS MCNT_CD   								-- 발생가맹점코드
	        , E.MCNT_NM AS MCNT_NM2  							-- 발생가맹점명
	        , A.PNT_KND_CD AS PNT_KND_CD     					-- 포인트종류코드
	        , H.DTL_CD_NM AS DTL_CD_NM2      					-- 포인트종류명
	        , A.SLIP_CD AS SLIP_CD   									-- 전표코드
	        , I.DTL_CD_NM AS DTL_CD_NM3      					-- 전표명
	        , A.SALE_AMT AS SALE_AMT 								-- 매출금액
	        , A.PNT AS PNT   												-- 포인트
	        , A.CS_MBR_CMMSN AS CS_MBR_CMMSN 				-- 제휴사연회비
	        , A.CMMSN AS CMMSN       								-- 수수료
	        , A.PMNT_WAY_CD AS PMNT_WAY_CD   				-- 지불수단코드
	        , J.DTL_CD_NM AS DTL_CD_NM4      					-- 지불수단명
	        , A.ORG_CD AS ORG_CD     								-- 기관코드
	        , K.DTL_CD_NM AS DTL_CD_NM5      					-- 기관명
	        , A.OIL_PRDCT_SGRP_CD AS OIL_PRDCT_SGRP_CD -- 유종코드
	        , L.DTL_CD_NM AS DTL_CD_NM6      					-- 유종명
	        , A.CPN_PRD_CD AS CPN_PRD_CD     					-- 쿠폰코드
	        , F.PRD_NM AS PRD_NM      								-- 쿠폰명
	        , A.ORIAPPR_DT AS ORIAPPR_DT  						-- 원승인일자
	        , A.ORIAPPR_NO AS ORIAPPR_NO   						-- 원승인번호
	        , A.CNCL_SLIP_TP_CD AS CNCL_SLIP_TP_CD 		-- 취소전표유형코드
	        , M.DTL_CD_NM AS CNCL_SLIP_TP_NM  				-- 취소전표유형명
        	<if test="extractTarget!= null and extractTarget == 'tr_mbrKorNm'">
          		, #{memberKorNm} AS MEMBERKORNM 			-- 한글이름
        	</if>
        FROM   (
	        SELECT A.RCV_DT
		        , CONCAT(A.APPR_DT, ' ', A.APPR_TM) AS APPR_DTTM
		        , A.REP_APPR_NO
		        , A.APPR_NO
		        , CONCAT(A.SALE_DT, ' ', A.SALE_TM) AS SALE_DTTM
		        , A.MBR_ID
		        , A.CARD_DTL_GRP_CD
		        , A.CARD_NO
		        , A.STLMT_ALCMPN_CD
		        , A.STLMT_MCNT_CD
		        , A.ALCMPN_CD
		        , A.MCNT_CD
		        , A.PNT_KND_CD
		        , A.SLIP_CD
		        , A.SALE_AMT
		        , A.OCC_PNT + AVL_PNT AS PNT
		        , A.CS_MBR_CMMSN
		        , A.CMMSN
		        , A.PMNT_WAY_CD
		        , A.ORG_CD
		        , A.OIL_PRDCT_SGRP_CD
		        , A.CPN_PRD_CD
		        , A.ORIAPPR_DT
		        , A.ORIAPPR_NO
		        , A.CNCL_SLIP_TP_CD
		        , A.ACS_MDIA_SRNO
	        FROM   (
	        		SELECT RCV_DT,RCV_SEQ,APPR_DT,APPR_TM,REP_APPR_NO,APPR_NO,SALE_DT,SALE_TM,MBR_ID,CARD_DTL_GRP_CD,
				        FUNCS.SECUAESDECRYPT(CARD_NO) CARD_NO,ALCMPN_CD,STLMT_ALCMPN_CD,MCNT_CD,STLMT_MCNT_CD,PNT_KND_CD,
				        SLIP_CD,SALE_AMT,OCC_PNT,AVL_PNT,CS_MBR_CMMSN,CMMSN,PMNT_WAY_CD,ORG_CD,OIL_PRDCT_SGRP_CD,SALE_QTY,CPN_PRD_CD,
				        CASE
				        	WHEN #{extractCond} = 't' THEN '1'
				        	WHEN #{extractCond} = 'g' AND ( LENGTH(STLMT_MCNT_CD) &lt;&gt; ( '5' ) OR STLMT_MCNT_CD IN ( 'HOMEP', 'PINIX', 'BOHUM' ) ) THEN '1'
				        	WHEN #{extractCond} = 'f'
				        		AND ( LENGTH(STLMT_MCNT_CD) = ( '5' )
				        		AND STLMT_MCNT_CD NOT IN ( 'HOMEP', 'PINIX', 'BOHUM' ) ) THEN '1' ELSE '2'
				        END AS TR_IND,
				        ORIAPPR_DT,
				        ORIAPPR_NO,
				        CNCL_SLIP_TP_CD,
				        ACS_MDIA_SRNO
			        FROM   OCB.DW_SALE_CTNT
			        WHERE  INTG_SLIP_FG_CD IN ('g') 
			        	AND SUBSTRING(SLIP_CD, 1, 1) NOT IN ( 'I' )
			        	AND SLIP_CD NOT IN ( 'A1', 'A2' )
			        	<choose>
			          		<when test="periodType == 'sale_dt'">
			            		AND SALE_DT BETWEEN #{periodFrom} AND #{periodTo}
			          		</when>
			          		<otherwise>
			            		AND RCV_DT BETWEEN #{periodFrom} AND #{periodTo}
			          		</otherwise>
						</choose>
	        	UNION ALL
			        SELECT RCV_DT,RCV_SEQ,APPR_DT,APPR_TM,REP_APPR_NO,APPR_NO,SALE_DT,SALE_TM,MBR_ID,CARD_DTL_GRP_CD,
				        FUNCS.SECUAESDECRYPT(CARD_NO) CARD_NO,ALCMPN_CD,STLMT_ALCMPN_CD,MCNT_CD,STLMT_MCNT_CD,PNT_KND_CD,
				        SLIP_CD,SALE_AMT,OCC_PNT,AVL_PNT,CS_MBR_CMMSN,CMMSN,PMNT_WAY_CD,ORG_CD,OIL_PRDCT_SGRP_CD,SALE_QTY,CPN_PRD_CD,
				        CASE
				        	WHEN #{extractCond} = 't' THEN '1'
				        	WHEN #{extractCond} = 'g'
				        		AND ( LENGTH(STLMT_MCNT_CD) &lt;&gt; ( '5' ) OR STLMT_MCNT_CD IN ( 'HOMEP', 'PINIX', 'BOHUM' ) ) THEN '1'
				        	WHEN #{extractCond} = 'f'
				        		AND ( LENGTH(STLMT_MCNT_CD) = ( '5' ) AND STLMT_MCNT_CD NOT IN ( 'HOMEP', 'PINIX', 'BOHUM' ) ) THEN '1' ELSE '2'
				        END AS TR_IND,
				        ORIAPPR_DT,
				        ORIAPPR_NO,
				        CNCL_SLIP_TP_CD,
				        ACS_MDIA_SRNO
			        FROM   OCB.DW_MTH07_PREV_SALE_CTNT
			        WHERE  SUBSTRING(SLIP_CD, 1, 1) NOT IN ( 'I' )
			        	AND SLIP_CD NOT IN ( 'A1', 'A2' )
			        	AND RCV_YM BETWEEN SUBSTRING(#{periodFrom}, 1, 6) AND SUBSTRING(#{periodTo}, 1, 6)
			        	<choose>
			          		<when test="periodType == 'sale_dt'">
			            		AND SALE_DT BETWEEN #{periodFrom} AND #{periodTo}
			          		</when>
			          		<otherwise>
			            		AND RCV_DT BETWEEN #{periodFrom} AND #{periodTo}
			          		</otherwise>
						</choose>
	        	UNION ALL
			        SELECT RCV_DT,RCV_SEQ,APPR_DT,APPR_TM,REP_APPR_NO,APPR_NO,SALE_DT,SALE_TM,MBR_ID,CARD_DTL_GRP_CD,
				        FUNCS.SECUAESDECRYPT(CARD_NO) CARD_NO,ALCMPN_CD,STLMT_ALCMPN_CD,MCNT_CD,STLMT_MCNT_CD,PNT_KND_CD,
				        SLIP_CD,SALE_AMT,OCC_PNT,AVL_PNT,CS_MBR_CMMSN,CMMSN,PMNT_WAY_CD,ORG_CD,OIL_PRDCT_SGRP_CD,SALE_QTY,CPN_PRD_CD,
				        CASE
				        	WHEN #{extractCond} = 't' THEN '1'
				        	WHEN #{extractCond} = 'g'
				        		AND ( LENGTH(STLMT_MCNT_CD) &lt;&gt; ( '5' ) OR STLMT_MCNT_CD IN ( 'HOMEP', 'PINIX', 'BOHUM' ) ) THEN '1'
				        	WHEN #{extractCond} = 'f'
				        		AND ( LENGTH(STLMT_MCNT_CD) = ( '5' ) AND STLMT_MCNT_CD NOT IN ( 'HOMEP', 'PINIX', 'BOHUM' ) ) THEN '1' ELSE '2'
				        END AS TR_IND,
				        ORIAPPR_DT,
				        ORIAPPR_NO,
				        CNCL_SLIP_TP_CD,
				        ACS_MDIA_SRNO
			        FROM   OCB.DW_MTH37_PREV_SALE_CTNT
			        WHERE  SUBSTRING(SLIP_CD, 1, 1) NOT IN ( 'I' )
			        	AND SLIP_CD NOT IN ( 'A1', 'A2' )
			        	AND RCV_YM BETWEEN Substring(#{periodFrom}, 1, 6) AND SUBSTRING(#{periodTo}, 1, 6)
				        <choose>
				       		<when test="periodType == 'sale_dt'">
				            	AND SALE_DT BETWEEN #{periodFrom} AND #{periodTo}
				          	</when>
				          	<otherwise>
				            	AND RCV_DT BETWEEN #{periodFrom} AND #{periodTo}
				          	</otherwise>
						</choose>
	        ) A
        	WHERE  A.TR_IND = '1'
        	AND A.MBR_ID = #{memberId}
        	LIMIT  50000
        ) A
        LEFT OUTER JOIN OCB.DW_ALCMPN_MST B ON A.STLMT_ALCMPN_CD = B.ALCMPN_CD
        LEFT OUTER JOIN OCB.DW_MCNT_MST C ON A.STLMT_MCNT_CD = C.MCNT_CD
        LEFT OUTER JOIN OCB.DW_ALCMPN_MST D ON A.ALCMPN_CD = D.ALCMPN_CD
        LEFT OUTER JOIN OCB.DW_MCNT_MST E ON A.MCNT_CD = E.MCNT_CD
        LEFT OUTER JOIN OCB.DW_CPN_PRD_MST F ON A.CPN_PRD_CD = F.CPN_PRD_CD
        LEFT OUTER JOIN (SELECT DTL_CD, DTL_CD_NM FROM OCB.DW_OCB_INTG_CD WHERE DOMN_ID = 'CARD_DTL_GRP_CD') G ON A.CARD_DTL_GRP_CD = G.DTL_CD
        LEFT OUTER JOIN (SELECT DTL_CD, DTL_CD_NM FROM OCB.DW_OCB_INTG_CD WHERE DOMN_ID = 'PNT_KND_CD') H ON A.PNT_KND_CD = H.DTL_CD
        LEFT OUTER JOIN (SELECT DTL_CD, DTL_CD_NM FROM OCB.DW_OCB_INTG_CD WHERE DOMN_ID = 'SLIP_CD') I ON A.SLIP_CD = I.DTL_CD
        LEFT OUTER JOIN (SELECT DTL_CD, DTL_CD_NM FROM OCB.DW_OCB_INTG_CD WHERE DOMN_ID = 'PMNT_WAY_CD') J ON A.PMNT_WAY_CD = J.DTL_CD
        LEFT OUTER JOIN (SELECT DTL_CD, DTL_CD_NM FROM OCB.DW_OCB_INTG_CD WHERE DOMN_ID = 'ORG_CD') K ON A.ORG_CD = K.DTL_CD
        LEFT OUTER JOIN (SELECT DTL_CD, DTL_CD_NM FROM OCB.DW_OCB_INTG_CD WHERE DOMN_ID = 'CAR_OIL_PRDCT_SGRP_CD') L ON A.OIL_PRDCT_SGRP_CD = L.DTL_CD
        LEFT OUTER JOIN (SELECT DTL_CD, DTL_CD_NM FROM OCB.DW_OCB_INTG_CD WHERE DOMN_ID = 'CNCL_SLIP_TP_CD') M ON A.CNCL_SLIP_TP_CD = M.DTL_CD
        LEFT OUTER JOIN USER_BI_OCB.WK_CARD_NO_ACS_MDIA_SRNO_MPNG_MST N ON A.ACS_MDIA_SRNO = N.ACS_MDIA_SRNO
    </select>

	<select id="selectTrSingleRequest" parameterType="SingleReq" resultType="AutoMap" databaseId="hsql">
		SELECT
			RCV_DT
			, APPR_DTTM
			, REP_APPR_NO
			, APPR_NO
			, SALE_DTTM
			, MBR_ID
			, CARD_DTL_GRP_CD
			, DTL_CD_NM
			, CARD_NO
			, STLMT_ALCMPN_CD
			, ALCMPN_NM
			, STLMT_MCNT_CD
			, MCNT_NM
			, ALCMPN_CD
			, ALCMPN_NM2
			, MCNT_CD
			, MCNT_NM2
			, PNT_KND_CD
			, DTL_CD_NM2
			, SLIP_CD
			, DTL_CD_NM3
			, SALE_AMT
			, PNT
			, CS_MBR_CMMSN
			, CMMSN
			, PMNT_WAY_CD
			, DTL_CD_NM4
			, ORG_CD
			, DTL_CD_NM5
			, OIL_PRDCT_SGRP_CD
			, DTL_CD_NM6
			, CPN_PRD_CD
			, PRD_NM
			, ORIAPPR_DT
			, ORIAPPR_NO
			, CNSL_SLIP_TP_CD
			, CNSL_SLIP_TP_NM
			<if test="extractTarget!= null and extractTarget == 'tr_mbrKorNm'">
			,#{memberKorNm} AS MEMBERKORNM -- 한글이름
			</if>
		FROM MOCK_QC_TEST
		WHERE MBR_ID = #{memberId}
	</select>

</mapper>
