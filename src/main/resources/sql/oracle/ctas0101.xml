<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.ctas.repository.oracle.OracleRepository">

	<sql id="pagingHead">
		SELECT *
		FROM (
			SELECT IN_SQ.*, ROWNUM AS RNUM
			FROM (
	</sql>

	<sql id="pagingFoot">
			) IN_SQ
			WHERE ROWNUM &lt;= #{offset} + #{limit}
		)
		WHERE RNUM &gt; #{offset}
	</sql>
	<sql id="pagingFoot" databaseId="hsql">
		LIMIT #{offset}, #{limit}
	</sql>

	<select id="selectCampaign" parameterType="map" resultType="AutoMappedMap">
		<include refid="pagingHead" />
		<include refid="selectCampaign_inner" />
		<include refid="pagingFoot" />
	</select>
	<select id="selectCampaign" parameterType="map" resultType="AutoMappedMap" databaseId="hsql">
		<include refid="selectCampaign_inner" />
		<include refid="pagingFoot" />
	</select>

	<sql id="selectCampaign_inner">
		SELECT CMPGN_ID
			, CMPGN_NM
			, TO_CHAR(TO_DATE(MERGE_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS MERGE_DT
			, TO_CHAR(TO_DATE(SND_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS SND_DT
			, OBJ_REG_FG_CD
			, TOT_CNT
			, DUP_DEL_CNT
			, CMPGN_SND_CHNL_FG_CD
			, CASE STS_FG_CD WHEN '02' THEN '머지완료' WHEN '03' THEN '전송완료' ELSE '저장완료' END AS STS_FG_NM
			, UPD_ID
		FROM WEB_CMPGN_MST
		<where>
			<if test="periodFrom != null and periodFrom != ''">AND SND_DT &gt;= #{periodFrom}</if>
			<if test="periodTo != null and periodTo != ''">AND SND_DT &lt;= #{periodTo}</if>
		</where>
	</sql>

	<select id="countCampaign" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM (
		<include refid="selectCampaign_inner" />
		)
	</select>

	<select id="nextCampaignId" parameterType="map" resultType="string">
		SELECT 'CM' || TO_CHAR(SUBSTR(NVL(MAX(CMPGN_ID), 'CM00000'), 3) + 1, '09999') FROM WEB_CMPGN_MST
	</select>
	<select id="nextCampaignId" parameterType="map" resultType="string" databaseId="hsql">
		SELECT ( IFNULL(MAX(CMPGN_ID),'0') + 1 ) || '' FROM WEB_CMPGN_MST
	</select>

	<update id="upsertCampaign" parameterType="map">
		INSERT /*+ APPEND_VALUES */
		INTO WEB_CMPGN_MST ( CMPGN_ID, CMPGN_NM, MERGE_DT, CMPGN_SND_CHNL_FG_CD, STS_FG_CD, UPD_ID, UPT_DTTM, CRT_ID, CRT_DTTM )
		VALUES ( #{cmpgnId}, #{cmpgnNm}, #{mergeDt}, #{cmpgnSndChnlFgCd}, '01', #{username}, SYSDATE, #{username}, SYSDATE )
		ON DUPLICATE KEY
		<trim prefix="UPDATE" suffixOverrides=",">
			<if test="cmpgnNm != null and cmpgnNm != ''">CMPGN_NM = #{cmpgnNm},</if>
			<if test="mergeDt != null and mergeDt != ''">MERGE_DT = #{mergeDt},</if>
			<if test="sndDt != null and sndDt != ''">SND_DT = #{sndDt},</if>
			<if test="objRegFgCd != null and objRegFgCd != ''">OBJ_REG_FG_CD = #{objRegFgCd},</if>
			<if test="totCnt != null and totCnt != ''">TOT_CNT = TO_NUMBER(#{totCnt}),</if>
			<if test="dupDelCnt != null and dupDelCnt != ''">DUP_DEL_CNT = TO_NUMBER(#{dupDelCnt}),</if>
			<if test="cmpgnSndChnlFgCd != null and cmpgnSndChnlFgCd != ''">CMPGN_SND_CHNL_FG_CD = #{cmpgnSndChnlFgCd},</if>
			<if test="stsFgCd != null and stsFgCd != ''">STS_FG_CD = #{stsFgCd},</if>
			<if test="username != null and username != ''">UPD_ID = #{username},</if>
			UPT_DTTM = SYSDATE,
		</trim>
	</update>

	<delete id="deleteCampaign" parameterType="map">
		DELETE FROM WEB_CMPGN_MST WHERE CMPGN_ID = #{cmpgnId}
	</delete>
	
	<select id="selectCampaignDetail" parameterType="map" resultType="AutoMappedMap">
		SELECT CELL_ID
			, CELL_DESC
			, 0 AS CELL_PRCNTG
			, EXTRCT_CNT
			, FNL_EXTRCT_CNT
			, MERGE_DT
			, SND_DT
			, CASE STS_FG_CD WHEN '02' THEN '추출완료' WHEN '03' THEN '전송완료' ELSE '' END AS STS_FG_NM
		FROM WEB_CMPGN_DTL
		WHERE CMPGN_ID = #{cmpgnId}
	</select>

	<insert id="insertCampaignDetail" parameterType="map">
		INSERT /*+ APPEND_VALUES */
		INTO WEB_CMPGN_DTL ( CELL_ID, CMPGN_ID, EXTRCT_CNT, MERGE_DT, CELL_DESC, STS_FG_CD, UPD_ID, UPT_DTTM, CRT_ID, CRT_DTTM )
		VALUES ( #{cellId}, #{cmpgnId}, #{extrctCnt}, #{mergeDt}, #{cellDesc}, '02', #{username}, SYSDATE, #{username}, SYSDATE )
	</insert>

	<delete id="deleteCampaignDetail" parameterType="map">
		DELETE FROM WEB_CMPGN_DTL WHERE CMPGN_ID = #{cmpgnId}
	</delete>

</mapper>
