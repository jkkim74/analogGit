<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.ctas.repository.oracle.OracleRepository">

	<sql id="pagingHead">
		SELECT *
		FROM (
			SELECT IN_SQ.*, ROWNUM AS RNUM
			FROM (
	</sql>

	<sql id="pagingFoot">
			) IN_SQ
			WHERE ROWNUM &lt;= #{offset} + #{limit}
		)
		WHERE RNUM &gt; #{offset}
	</sql>
	<sql id="pagingFoot" databaseId="hsql">
		LIMIT #{offset}, #{limit}
	</sql>

	<select id="selectCampaign" parameterType="map" resultType="AutoMappedMap">
		<include refid="selectCampaign_inner" />
	</select>

	<select id="selectCampaigns" parameterType="map" resultType="AutoMappedMap">
		<include refid="pagingHead" />
		<include refid="selectCampaign_inner" />
		<include refid="pagingFoot" />
		ORDER BY CMPGN_ID
	</select>
	<select id="selectCampaigns" parameterType="map" resultType="AutoMappedMap" databaseId="hsql">
		<include refid="selectCampaign_inner" />
		<include refid="pagingFoot" />
	</select>

	<sql id="selectCampaign_inner">
		SELECT CMPGN_ID
			, CMPGN_NM
			, TO_CHAR(TO_DATE(MERGE_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS MERGE_DT
			, TO_CHAR(TO_DATE(SND_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS SND_DT
			, OBJ_REG_FG_CD
			, TOT_CNT
			, DUP_DEL_CNT
			, CMPGN_SND_CHNL_FG_CD
			, STS_FG_CD
			, CASE STS_FG_CD WHEN '02' THEN '추출완료' WHEN '03' THEN '머지완료' WHEN '04' THEN '전송완료' ELSE '저장' END AS STS_FG_NM
			, UPD_ID
		FROM WEB_CMPGN_MST
		<where>
			<if test="cmpgnId != null and cmpgnId != ''">AND CMPGN_ID = #{cmpgnId} </if>
			<if test="periodFrom != null and periodFrom != ''">AND SND_DT &gt;= #{periodFrom} </if>
			<if test="periodTo != null and periodTo != ''">AND SND_DT &lt;= #{periodTo} </if>
		</where>
	</sql>

	<select id="countCampaigns" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM (
		<include refid="selectCampaign_inner" />
		)
	</select>

	<select id="nextCampaignId" parameterType="map" resultType="string">
		SELECT 'CM' || TO_CHAR(SUBSTR(NVL(MAX(CMPGN_ID), 'CM00000'), 3) + 1, 'FM09999') FROM WEB_CMPGN_MST
	</select>
	<select id="nextCampaignId" parameterType="map" resultType="string" databaseId="hsql">
		SELECT 'CM' || LPAD(CAST(SUBSTR(IFNULL(MAX(CMPGN_ID),'CM00000'), 3) AS INTEGER) + 1, 5, '0') FROM WEB_CMPGN_MST
	</select>

	<update id="upsertCampaign" parameterType="map">
		MERGE INTO WEB_CMPGN_MST A
			USING( SELECT #{cmpgnId} AS CMPGN_ID FROM DUAL) B
			ON( A.CMPGN_ID = B.CMPGN_ID )
		WHEN MATCHED THEN
		<trim prefix="UPDATE SET " suffixOverrides=",">
			<if test="cmpgnNm != null and cmpgnNm != ''">CMPGN_NM = #{cmpgnNm},</if>
			<if test="mergeDt != null and mergeDt != ''">MERGE_DT = #{mergeDt},</if>
			<if test="objRegFgCd != null and objRegFgCd != ''">OBJ_REG_FG_CD = #{objRegFgCd},</if>
			<if test="totCnt != null and totCnt != ''">TOT_CNT = TO_NUMBER(#{totCnt}),</if>
			<if test="dupDelCnt != null and dupDelCnt != ''">DUP_DEL_CNT = TO_NUMBER(#{dupDelCnt}),</if>
			<if test="cmpgnSndChnlFgCd != null and cmpgnSndChnlFgCd != ''">CMPGN_SND_CHNL_FG_CD = #{cmpgnSndChnlFgCd},</if>
			<if test="stsFgCd != null and stsFgCd != ''">
				STS_FG_CD = #{stsFgCd},
				<if test="stsFgCd == '04'">SND_DT = TO_CHAR(SYSDATE, 'YYYYMMDD'),</if>
			</if>
			<if test="username != null and username != ''">UPD_ID = #{username},</if>
			UPT_DTTM = SYSDATE,
		</trim>
		WHEN NOT MATCHED THEN
			INSERT ( CMPGN_ID, CMPGN_NM, MERGE_DT, OBJ_REG_FG_CD, TOT_CNT, DUP_DEL_CNT, CMPGN_SND_CHNL_FG_CD, STS_FG_CD, UPD_ID, UPT_DTTM, CRT_ID, CRT_DTTM )
			VALUES ( #{cmpgnId}, #{cmpgnNm, jdbcType=VARCHAR}, #{mergeDt, jdbcType=VARCHAR}, #{objRegFgCd, jdbcType=VARCHAR}, TO_NUMBER(#{totCnt, jdbcType=VARCHAR}), TO_NUMBER(#{dupDelCnt, jdbcType=VARCHAR}), #{cmpgnSndChnlFgCd, jdbcType=VARCHAR}, #{stsFgCd, jdbcType=VARCHAR}, #{username}, SYSDATE, #{username}, SYSDATE )
	</update>

	<delete id="deleteCampaign" parameterType="map">
		DELETE FROM WEB_CMPGN_MST WHERE CMPGN_ID = #{cmpgnId}
	</delete>
	
	<select id="selectCampaignDetails" parameterType="map" resultType="AutoMappedMap">
		SELECT A.CELL_ID
			, CMPGN_ID
			, A.CELL_DESC
			, CASE B.DUP_DEL_CNT WHEN 0 THEN 0 ELSE ROUND(A.EXTRCT_CNT / B.DUP_DEL_CNT * 100, 1) END AS CELL_PRCNTG
			, A.EXTRCT_CNT
			, A.FNL_EXTRCT_CNT
			, TO_CHAR(TO_DATE(A.MERGE_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS MERGE_DT
			, TO_CHAR(TO_DATE(A.SND_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS SND_DT
			, A.STS_FG_CD
			, CASE A.STS_FG_CD WHEN '02' THEN '추출완료' WHEN '03' THEN '머지완료' WHEN '04' THEN '전송완료' ELSE '저장' END AS STS_FG_NM
		FROM WEB_CMPGN_DTL A
		JOIN WEB_CMPGN_MST B USING(CMPGN_ID)
		WHERE CMPGN_ID = #{cmpgnId}
		ORDER BY CELL_ID
	</select>

	<select id="nextCellId" parameterType="map" resultType="string">
		SELECT 'CL' || SUBSTR(#{cmpgnId}, 3) || TO_CHAR(SUBSTR(NVL(MAX(CELL_ID), 'CL00000000'), 8) + 1, 'FM099')
		FROM WEB_CMPGN_DTL
		WHERE CMPGN_ID = #{cmpgnId} 
	</select>
	<select id="nextCellId" parameterType="map" resultType="string" databaseId="hsql">
		SELECT 'CL' || SUBSTR(#{cmpgnId}, 3) ||  LPAD(CAST(SUBSTR(IFNULL(MAX(CELL_ID), 'CL00000000'), 8) AS INTEGER) + 1, 3, '0')
		FROM WEB_CMPGN_DTL
		WHERE CMPGN_ID = #{cmpgnId} 
	</select>

	<insert id="upsertCampaignDetail" parameterType="map">
		MERGE INTO WEB_CMPGN_DTL A
			USING( SELECT #{cellId} AS CELL_ID FROM DUAL) B
			ON( A.CELL_ID = B.CELL_ID )
		WHEN MATCHED THEN
		<trim prefix="UPDATE SET " suffixOverrides=",">
			<if test="cellDesc != null and cellDesc != ''">CELL_DESC = #{cellDesc},</if>
			<if test="extrctCnt != null and extrctCnt != ''">EXTRCT_CNT = #{extrctCnt},</if>
			<if test="fnlExtrctCnt != null and fnlExtrctCnt != ''">FNL_EXTRCT_CNT = #{fnlExtrctCnt},</if>
			<if test="mergeDt != null and mergeDt != ''">MERGE_DT = #{mergeDt},</if>
			<if test="stsFgCd != null and stsFgCd != ''">
				STS_FG_CD = #{stsFgCd},
				<if test="stsFgCd == '04'">SND_DT = TO_CHAR(SYSDATE, 'YYYYMMDD'),</if>
			</if>
			<if test="username != null and username != ''">UPD_ID = #{username},</if>
			UPT_DTTM = SYSDATE,
		</trim>
		WHEN NOT MATCHED THEN
			INSERT ( CELL_ID, CMPGN_ID, EXTRCT_CNT, FNL_EXTRCT_CNT, MERGE_DT, CELL_DESC, STS_FG_CD, UPD_ID, UPT_DTTM, CRT_ID, CRT_DTTM )
			VALUES ( #{cellId}, #{cmpgnId}, #{extrctCnt, jdbcType=INTEGER}, #{fnlExtrctCnt, jdbcType=INTEGER},#{mergeDt, jdbcType=VARCHAR}, #{cellDesc, jdbcType=VARCHAR}, #{stsFgCd, jdbcType=VARCHAR}, #{username}, SYSDATE, #{username}, SYSDATE )
	</insert>

	<delete id="deleteCampaignDetail" parameterType="map">
		DELETE FROM WEB_CMPGN_DTL
		WHERE CMPGN_ID = #{cmpgnId}
		<if test="cellId != null and cellId != ''">AND CELL_ID = #{cellId} </if>
	</delete>
	
	<update id="balanceCellExtrctCnt" parameterType="map">
		UPDATE WEB_CMPGN_DTL A
		SET EXTRCT_CNT = 
		(
			SELECT
				CASE WHEN DTL_CNT = RNUM
				THEN TRUNC(DUP_DEL_CNT / DTL_CNT) + MOD(DUP_DEL_CNT, DTL_CNT)
				ELSE TRUNC(DUP_DEL_CNT / DTL_CNT)
				END AS EXTRCT_CNT
			FROM (
				SELECT CELL_ID
					, DUP_DEL_CNT
					, (SELECT COUNT(*) FROM WEB_CMPGN_DTL WHERE CMPGN_ID = #{cmpgnId}) AS DTL_CNT
					, ROWNUM AS RNUM
				FROM WEB_CMPGN_DTL
				JOIN WEB_CMPGN_MST USING(CMPGN_ID)
				WHERE CMPGN_ID = #{cmpgnId}
				ORDER BY CELL_ID
			) B
			WHERE B.CELL_ID = A.CELL_ID
		)
		WHERE CMPGN_ID = #{cmpgnId}
	</update>

</mapper>
