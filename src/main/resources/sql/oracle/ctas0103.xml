<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.ctas.repository.oracle.OracleRepository">

	<select id="selectCampaignTargetingInfo" parameterType="map" resultType="AutoMappedMap">
		SELECT TGTNG_CNDTN_CLMN_NM, TGTNG_CNDTN_CLMN_VAL
		FROM WEB_CMPGN_TGTNG_INFO
		WHERE CMPGN_ID = #{cmpgnId}
	</select>

	<insert id="insertCampaignTargetingInfo" parameterType="map">
		INSERT /*+ APPEND_VALUES */ ALL
		<foreach collection="targetingInfo" item="value" index="key" separator=" ">
			INTO WEB_CMPGN_TGTNG_INFO ( CMPGN_ID, TGTNG_CNDTN_CLMN_NM, TGTNG_CNDTN_CLMN_VAL, UPD_ID, UPT_DTTM, CRT_ID, CRT_DTTM )
				VALUES ( #{cmpgnId}, #{key}, #{value}, #{username}, SYSDATE, #{username}, SYSDATE )
		</foreach>
		SELECT * FROM DUAL
	</insert>
	<insert id="insertCampaignTargetingInfo" parameterType="map" databaseId="hsql">
		INSERT
		INTO WEB_CMPGN_TGTNG_INFO ( CMPGN_ID, TGTNG_CNDTN_CLMN_NM, TGTNG_CNDTN_CLMN_VAL, UPD_ID, UPT_DTTM, CRT_ID, CRT_DTTM )
		VALUES
		<foreach collection="targetingInfo" item="value" index="key" separator=",">
			( #{cmpgnId}, #{key}, #{value}, #{username}, SYSDATE, #{username}, SYSDATE )
		</foreach>
	</insert>
	
	<delete id="deleteCampaignTargetingInfo" parameterType="map">
		DELETE FROM WEB_CMPGN_TGTNG_INFO WHERE CMPGN_ID = #{cmpgnId}
	</delete>

	<select id="countCampaignTargetingCsvTable" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM USER_TABLES WHERE TABLE_NAME = 'WEB_TRGT_${cmpgnId}'
	</select>
	<select id="countCampaignTargetingCsvTable" parameterType="map" resultType="int" databaseId="hsql">
		SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'WEB_TRGT_' || #{cmpgnId}
	</select>

	<update id="createCampaignTargetingCsvTable" parameterType="map">
		CREATE TABLE WEB_TRGT_${cmpgnId}
		(
			MBR_ID VARCHAR2 (9)
		)
		TABLESPACE INTG_DTBS_TDE
		PCTFREE 10
		PCTUSED 0
		INITRANS 1
		MAXTRANS 255
		STORAGE
		(
			INITIAL 5242880
			NEXT 5242880
			MINEXTENTS 1
			MAXEXTENTS UNLIMITED
			BUFFER_POOL DEFAULT
		)
		NOLOGGING
	</update>
	<update id="createCampaignTargetingCsvTable" parameterType="map" databaseId="hsql">
		CREATE TABLE WEB_TRGT_${cmpgnId}
		(
			MBR_ID VARCHAR2 (9)
		)
	</update>

	<update id="truncateCampaignTargetingCsvTable" parameterType="map">
		TRUNCATE TABLE WEB_TRGT_${cmpgnId}
	</update>
	
	<insert id="insertCampaignTargetingCsvTmp" parameterType="map">
		INSERT /*+ APPEND_VALUES */ ALL
		<foreach collection="mbrIdList" item="item" separator=" ">
			INTO WEB_TRGT_${cmpgnId}_TMP VALUES ( #{item} )
		</foreach>
		SELECT * FROM DUAL
	</insert>
	<insert id="insertCampaignTargetingCsvTmp" parameterType="map" databaseId="hsql">
		INSERT INTO WEB_TRGT_${cmpgnId}_TMP
		VALUES
		<foreach collection="mbrIdList" item="item" separator=",">( #{item} )</foreach>
	</insert>

	<insert id="migrateCampaignTargetingCsv" parameterType="map">
		INSERT INTO WEB_TRGT_${cmpgnId}
		SELECT COLUMN1
		FROM TMP_${cmpgnId}_${username}
		GROUP BY COLUMN1
	</insert>

	<select id="countCampaignTargetingCsvTmp" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM TMP_${cmpgnId}_${username}
	</select>

	<select id="countCampaignTargetingCsv" parameterType="map" resultType="int">
		SELECT COUNT(*) FROM WEB_TRGT_${cmpgnId}
	</select>
	
	<select id="selectTargeting" parameterType="map" resultType="string">
		<include refid="pagingHead"/>
		SELECT MBR_ID FROM WEB_TRGT_${cmpgnId}
		<include refid="pagingFoot" />
	</select>
	<select id="selectTargeting" parameterType="map" resultType="string" databaseId="hsql">
		SELECT MBR_ID FROM WEB_TRGT_${cmpgnId}
		<include refid="pagingFoot" />
	</select>

	<select id="selectRegions" parameterType="map" resultType="AutoMappedMap">
		<choose>
			<when test="hrnkDtlCd != null and hrnkDtlCd != ''">
				SELECT DTL_CD, DTL_CD_NM
				FROM DW_OCB_INTG_CD
				WHERE DOMN_ID = 'HJD_MGRP_CD'
				AND HRNK_DTL_CD = #{hrnkDtlCd}
				AND SUBSTR(DTL_CD,3,6) NOT IN ('000')
				ORDER BY DTL_CD
			</when>
			<otherwise>
				SELECT DTL_CD, DTL_CD_NM
				FROM DW_OCB_INTG_CD
				WHERE DOMN_ID = 'HJD_LGRP_CD'
				AND TRIM(DTL_CD) NOT IN ('X','Y','Z')
				ORDER BY DTL_CD
			</otherwise>
		</choose>
	</select>
	
</mapper>
