<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.tcloud.CloudRepository">
     <select id="getTCloudMenuStatPerDay" parameterType="JqGridRequest" resultType="TcloudMenuStat">
        WITH groupT AS(
            SELECT com_cd, com_cd_nm, lpad(sort_seq,2,'0') sort_seq
              FROM TCD_D_COM_CD
             WHERE COM_GRP_CD = 'TCD5006'
        ),categoryT AS(
            SELECT comb_log_cd, comb_log_nm, lpad(sort_seq,2,'0') sort_seq, PAGE_1_DEPTH_CD
              FROM TCD_APP_LOG_CHG_CD
             WHERE com_grp_cd = #{commonGroupCode}
        ), t AS (
            SELECT TO_CHAR(TO_DATE(stdT.BASE_DT, 'YYYYMMDD'), 'YYYY-MM-DD')||'('||TO_CHAR(TO_DATE(stdT.BASE_DT, 'YYYYMMDD'), 'dy')|| ')' AS standardDate,
                   (gt.sort_seq||'@'||gt.com_cd_nm) AS menuDepth1,
                   (ct.sort_seq||'@'|| ct.comb_log_nm) AS menuDepth2,
                   stdT.uv_cnt AS uv,
                   stdT.pv_cnt AS pv,
                   stdT.STAY_TMS AS stayTime
              From TCD_F_D_DAY_APP_LOG stdT, groupT gt, categoryT ct
             WHERE COM_GRP_CD = #{commonGroupCode}
               AND stdT.comb_log_cd = ct.comb_log_cd
               AND gt.com_cd = ct.PAGE_1_DEPTH_CD
               AND stdT.base_dt BETWEEN #{startDate} AND #{endDate}
          ORDER BY standardDate, menuDepth1, menuDepth2)
      SELECT standardDate,
             menuDepth1,
             menuDepth2,
             DECODE(measure,
                    'UV','001UV',
                    'PV','002PV') AS measure,
             measure_value
        FROM t UNPIVOT (measure_value FOR measure IN (uv,pv))
       WHERE measure_value != 0
    ORDER BY standardDate, menuDepth1, menuDepth2, measure
    </select>

    <select id="getTCloudMenuStatPerMonth" parameterType="JqGridRequest" resultType="TcloudMenuStat">
        WITH groupT AS(
            SELECT com_cd, com_cd_nm, lpad(sort_seq,2,'0') sort_seq
              FROM TCD_D_COM_CD
             WHERE COM_GRP_CD = 'TCD5006'
        ),categoryT AS(
            SELECT comb_log_cd, comb_log_nm, lpad(sort_seq,2,'0') sort_seq, PAGE_1_DEPTH_CD
              FROM TCD_APP_LOG_CHG_CD
             WHERE com_grp_cd = #{commonGroupCode}
        ), t AS (
            SELECT TO_CHAR (TO_DATE (stdT.base_ym, 'YYYYMM'), 'YYYY-MM') AS standardDate,
                   (gt.sort_seq||'@'|| gt.com_cd_nm) AS menuDepth1,
                   (ct.sort_seq||'@'|| ct.comb_log_nm) AS menuDepth2,
                   stdT.uv_cnt AS uv,
                   stdT.pv_cnt AS pv,
                   stdT.STAY_TMS AS stayTime
              From TCD_F_D_MON_APP_LOG stdT, groupT gt, categoryT ct
             WHERE COM_GRP_CD = #{commonGroupCode}
               AND stdT.comb_log_cd = ct.comb_log_cd
               AND gt.com_cd = ct.PAGE_1_DEPTH_CD
               AND stdT.base_ym BETWEEN #{startDate} AND #{endDate}
          ORDER BY standardDate, menuDepth1, menuDepth2)
      SELECT standardDate,
             menuDepth1,
             menuDepth2,
             DECODE(measure,
                    'UV','001UV',
                    'PV','002PV') AS measure,
             measure_value
        FROM t UNPIVOT (measure_value FOR measure IN (uv,pv))
       WHERE measure_value != 0
    ORDER BY standardDate, menuDepth1, menuDepth2, measure
    </select>

    <select id="old_getTCloudMenuStatPerDay" parameterType="JqGridRequest" resultType="TcloudMenuStat">
        WITH groupT AS(
            SELECT com_cd, com_cd_nm, lpad(sort_seq,2,'0') sort_seq
              FROM TCD_D_COM_CD
             WHERE COM_GRP_CD = 'TCD5006'
        ),categoryT AS(
            SELECT comb_log_cd, comb_log_nm, lpad(sort_seq,2,'0') sort_seq, PAGE_1_DEPTH_CD
              FROM TCD_APP_LOG_CHG_CD
             WHERE com_grp_cd = #{commonGroupCode}
        )
        SELECT TO_CHAR(TO_DATE(stdT.BASE_DT, 'YYYYMMDD'), 'YYYY-MM-DD')||'('||TO_CHAR(TO_DATE(stdT.BASE_DT, 'YYYYMMDD'), 'dy')|| ')' AS standardDate,
               (gt.sort_seq|| '@@' || gt.com_cd_nm) AS menuDepth1,
               (ct.sort_seq|| '@@' || ct.comb_log_nm) AS menuDepth2,
               stdT.uv_cnt AS uv,
               stdT.pv_cnt AS pv,
               stdT.STAY_TMS AS stayTime
          From TCD_F_D_DAY_APP_LOG stdT, groupT gt, categoryT ct
         WHERE COM_GRP_CD = #{commonGroupCode}
           AND stdT.comb_log_cd = ct.comb_log_cd
           AND gt.com_cd = ct.PAGE_1_DEPTH_CD
           AND stdT.base_dt BETWEEN #{startDate} AND #{endDate}
      ORDER BY standardDate, menuDepth1, menuDepth2
    </select>

    <select id="old_getTCloudMenuStatPerMonth" parameterType="JqGridRequest" resultType="TcloudMenuStat">
        WITH groupT AS(
            SELECT com_cd, com_cd_nm, lpad(sort_seq,2,'0') sort_seq
              FROM TCD_D_COM_CD
             WHERE COM_GRP_CD = 'TCD5006'
        ),categoryT AS(
            SELECT comb_log_cd, comb_log_nm, lpad(sort_seq,2,'0') sort_seq, PAGE_1_DEPTH_CD
              FROM TCD_APP_LOG_CHG_CD
             WHERE com_grp_cd = #{commonGroupCode}
        )
        SELECT TO_CHAR (TO_DATE (stdT.base_ym, 'YYYYMM'), 'YYYY-MM') AS standardDate,
               (gt.sort_seq|| '@@' || gt.com_cd_nm) AS menuDepth1,
               (ct.sort_seq|| '@@' || ct.comb_log_nm) AS menuDepth2,
               stdT.uv_cnt AS uv,
               stdT.pv_cnt AS pv,
               stdT.STAY_TMS AS stayTime
          From TCD_F_D_MON_APP_LOG stdT, groupT gt, categoryT ct
         WHERE COM_GRP_CD = #{commonGroupCode}
           AND stdT.comb_log_cd = ct.comb_log_cd
           AND gt.com_cd = ct.PAGE_1_DEPTH_CD
           AND stdT.base_ym BETWEEN #{startDate} AND #{endDate}
      ORDER BY standardDate, menuDepth1, menuDepth2
    </select>
</mapper>
