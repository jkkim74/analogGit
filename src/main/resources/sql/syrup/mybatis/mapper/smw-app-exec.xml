<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skplanet.bisportal.repository.syrup.SmwAppExecRepository">

    <select id="getAppVisitSituationPerDay" parameterType="OlapDimensionRequest" resultType="SmwAppExec">
        WITH SMW_CODE1 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW001'),
         SMW_CODE3 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW003'),
         SMW_CODE4 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW019'),
         SMW_CODE5 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW004'),
         SMW_CODE6 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW002')
            SELECT
                <if test="useOs != null">
                     c1.cd_nm AS os,
                </if>
                <if test="useSex != null">
                     c3.cd_nm AS sex,
                </if>
                <if test="useAppVersion != null">
                     c4.cd_nm AS appVersion,
                </if>
                <if test="useAgeRange!= null">
                     c5.cd_nm AS ageRange,
                </if>
                <if test="useTelecom != null">
                     c6.cd_nm AS telecom,
                </if>
                <if test="useStandardDate != null">
                    TO_CHAR(TO_DATE(t.STRD_DT, 'YYYYMMDD'), 'YYYY-MM-DD')||'('||TO_CHAR(TO_DATE(t.STRD_DT, 'YYYYMMDD'), 'dy')|| ')' AS standardDate,
                </if>
                     SUM ( t.TOT_UV )       AS totUv,
                     SUM ( t.TOT_PV )       AS totPv,
                     SUM ( t.MBR_UV )       AS mbrUv,
                     SUM ( t.MBR_PV )       AS mbrPv,
                     SUM ( t.WLET_EXEC_UV ) AS wletExecUv,
                     SUM ( t.WLET_EXEC_PV ) AS wletExecPv,
                     SUM ( t.MBRSH_TWN_UV ) AS mbrshTwnUv,
                     SUM ( t.MBRSH_TWN_PV ) AS mbrshTwnPv,
                     SUM ( t.WDG_EXEC_UV )  AS wdgExecUv,
                     SUM ( t.WDG_EXEC_PV )  AS wdgExecPv
                FROM SMW_D_APP_EXEC t, SMW_CODE1 c1, SMW_CODE3 c3, SMW_CODE4 c4, SMW_CODE5 c5, SMW_CODE6 c6
               WHERE t.strd_dt BETWEEN #{startDate} AND #{endDate}
                 AND t.app_ver = 'T'
                 AND t.os_cd = c1.com_cd(+)
                 AND t.gndr_cd = c3.com_cd(+)
                 AND t.app_ver = c4.com_cd(+)
                 AND t.age_rng_cd = c5.com_cd(+)
                 AND t.telc_cd = c6.com_cd(+)
            <trim prefix="GROUP BY" suffixOverrides=",">
                <if test="useOs != null">
                    c1.cd_nm,
                </if>
                <if test="useSex != null">
                    c3.cd_nm,
                </if>
                <if test="useAppVersion != null">
                    c4.cd_nm,
                </if>
                <if test="useAgeRange!= null">
                    c5.cd_nm,
                </if>
                <if test="useTelecom != null">
                    c6.cd_nm,
                </if>
                <if test="useStandardDate != null">
                    t.strd_dt,
                </if>
            </trim>
    </select>

    <select id="getAppVisitSituationPerWeek" parameterType="OlapDimensionRequest" resultType="SmwAppExec">
        WITH SMW_CODE1 AS (
           SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW001'),
         SMW_CODE3 AS (
           SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW003'),
         SMW_CODE4 AS (
           SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW019'),
         SMW_CODE5 AS (
           SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW004'),
         SMW_CODE6 AS (
           SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW002'),
         dateS AS (
           SELECT strd_year||LPAD(strd_wk_seq,2,'0') dateStr
             FROM smw_cldr_wk
            WHERE #{startDate} BETWEEN wk_st_dt AND wk_ed_dt),
         dateE AS (
           SELECT strd_year||LPAD(strd_wk_seq,2,'0') dateStr
             FROM smw_cldr_wk
            WHERE #{endDate} BETWEEN wk_st_dt AND wk_ed_dt)
        SELECT
                <if test="useOs != null">
                     c1.cd_nm AS os,
                </if>
                <if test="useSex != null">
                     c3.cd_nm AS sex,
                </if>
                <if test="useAppVersion != null">
                     c4.cd_nm AS appVersion,
                </if>
                <if test="useAgeRange!= null">
                     c5.cd_nm AS ageRange,
                </if>
                <if test="useTelecom != null">
                     c6.cd_nm AS telecom,
                </if>
                <if test="useStandardDate != null">
                     t.strd_yr||'('||LPAD(t.strd_wk, 2, '0')||')' AS standardDate,
                </if>
                     SUM ( t.TOT_UV )       AS totUv,
                     SUM ( t.TOT_PV )       AS totPv,
                     SUM ( t.MBR_UV )       AS mbrUv,
                     SUM ( t.MBR_PV )       AS mbrPv,
                     SUM ( t.WLET_EXEC_UV ) AS wletExecUv,
                     SUM ( t.WLET_EXEC_PV ) AS wletExecPv,
                     SUM ( t.MBRSH_TWN_UV ) AS mbrshTwnUv,
                     SUM ( t.MBRSH_TWN_PV ) AS mbrshTwnPv,
                     SUM ( t.WDG_EXEC_UV )  AS wdgExecUv,
                     SUM ( t.WDG_EXEC_PV )  AS wdgExecPv
                FROM SMW_W_APP_EXEC t, SMW_CODE1 c1, SMW_CODE3 c3, SMW_CODE4 c4, SMW_CODE5 c5, SMW_CODE6 c6, dateS, dateE
               WHERE (t.strd_yr||LPAD(t.strd_wk,2,'0')) BETWEEN dateS.dateStr AND dateE.dateStr
                 AND t.app_ver = 'T'
                 AND t.os_cd = c1.com_cd(+)
                 AND t.gndr_cd = c3.com_cd(+)
                 AND t.app_ver = c4.com_cd(+)
                 AND t.age_rng_cd = c5.com_cd(+)
                 AND t.telc_cd = c6.com_cd(+)
            <trim prefix="GROUP BY" suffixOverrides=",">
                <if test="useOs != null">
                    c1.cd_nm,
                </if>
                <if test="useSex != null">
                    c3.cd_nm,
                </if>
                <if test="useAppVersion != null">
                    c4.cd_nm,
                </if>
                <if test="useAgeRange!= null">
                    c5.cd_nm,
                </if>
                <if test="useTelecom != null">
                    c6.cd_nm,
                </if>
                <if test="useStandardDate != null">
                    t.strd_yr||'('||LPAD(t.strd_wk,2,'0')||')',
                </if>
            </trim>
    </select>

    <select id="getAppVisitSituationPerMonth" parameterType="OlapDimensionRequest" resultType="SmwAppExec">
        WITH SMW_CODE1 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW001'),
         SMW_CODE3 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW003'),
         SMW_CODE4 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW019'),
         SMW_CODE5 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW004'),
         SMW_CODE6 AS (
         SELECT com_cd, (sort_seq||'@@'||cd_nm) cd_nm
             FROM smw_code
            WHERE use_yn = 'Y'
                AND lcl_cd  = 'SMW002')
            SELECT
                <if test="useOs != null">
                     c1.cd_nm AS os,
                </if>
                <if test="useSex != null">
                     c3.cd_nm AS sex,
                </if>
                <if test="useAppVersion != null">
                     c4.cd_nm AS appVersion,
                </if>
                <if test="useAgeRange!= null">
                     c5.cd_nm AS ageRange,
                </if>
                <if test="useTelecom != null">
                     c6.cd_nm AS telecom,
                </if>
                <if test="useStandardDate != null">
                     TO_CHAR (TO_DATE (t.strd_ym, 'YYYYMM'), 'YYYY-MM') AS standardDate,
                </if>
                     SUM ( t.TOT_UV )       AS totUv,
                     SUM ( t.TOT_PV )       AS totPv,
                     SUM ( t.MBR_UV )       AS mbrUv,
                     SUM ( t.MBR_PV )       AS mbrPv,
                     SUM ( t.WLET_EXEC_UV ) AS wletExecUv,
                     SUM ( t.WLET_EXEC_PV ) AS wletExecPv,
                     SUM ( t.MBRSH_TWN_UV ) AS mbrshTwnUv,
                     SUM ( t.MBRSH_TWN_PV ) AS mbrshTwnPv,
                     SUM ( t.WDG_EXEC_UV )  AS wdgExecUv,
                     SUM ( t.WDG_EXEC_PV )  AS wdgExecPv
                FROM SMW_M_APP_EXEC t, SMW_CODE1 c1, SMW_CODE3 c3, SMW_CODE4 c4, SMW_CODE5 c5, SMW_CODE6 c6
               WHERE t.strd_ym BETWEEN #{startDate} AND #{endDate}
                 AND t.app_ver = 'T'
                 AND t.os_cd = c1.com_cd(+)
                 AND t.gndr_cd = c3.com_cd(+)
                 AND t.app_ver = c4.com_cd(+)
                 AND t.age_rng_cd = c5.com_cd(+)
                 AND t.telc_cd = c6.com_cd(+)
            <trim prefix="GROUP BY" suffixOverrides=",">
                <if test="useOs != null">
                    c1.cd_nm,
                </if>
                <if test="useSex != null">
                    c3.cd_nm,
                </if>
                <if test="useAppVersion != null">
                    c4.cd_nm,
                </if>
                <if test="useAgeRange!= null">
                    c5.cd_nm,
                </if>
                <if test="useTelecom != null">
                    c6.cd_nm,
                </if>
                <if test="useStandardDate != null">
                    t.strd_ym,
                </if>
            </trim>
    </select>


</mapper>
